var Viva=Viva||{};Viva.Graph=Viva.Graph||{},"undefined"!=typeof module&&module.exports&&(module.exports=Viva),Viva.Graph.version="0.5.7",Viva.lazyExtend=function(e,t){var n;if(e||(e={}),t)for(n in t)if(t.hasOwnProperty(n)){var r=e.hasOwnProperty(n),i=typeof t[n],o=!r||typeof e[n]!==i;o?e[n]=t[n]:"object"===i&&(e[n]=Viva.lazyExtend(e[n],t[n]))}return e},Viva.random=function(){var e,t=arguments[0];e="number"==typeof t?t:"string"==typeof t?t.length:+new Date;var n=function(){return e=4294967295&e+2127912214+(e<<12),e=4294967295&(3345072700^e^e>>>19),e=4294967295&e+374761393+(e<<5),e=4294967295&(e+3550635116^e<<9),e=4294967295&e+4251993797+(e<<3),e=4294967295&(3042594569^e^e>>>16),(268435455&e)/268435456};return{next:function(e){return Math.floor(n()*e)},nextDouble:function(){return n()}}},Viva.randomIterator=function(e,t){return t=t||Viva.random(),{forEach:function(n){var r,i,o;for(r=e.length-1;r>0;--r)i=t.next(r+1),o=e[i],e[i]=e[r],e[r]=o,n(o);e.length&&n(e[0])},shuffle:function(){var n,r,i;for(n=e.length-1;n>0;--n)r=t.next(n+1),i=e[r],e[r]=e[n],e[n]=i;return e}}},Viva.BrowserInfo=function(){if("undefined"==typeof window||!window.hasOwnProperty("navigator"))return{browser:"",version:"0"};var e=window.navigator.userAgent.toLowerCase(),t=/(webkit)[ \/]([\w.]+)/,n=/(opera)(?:.*version)?[ \/]([\w.]+)/,r=/(msie) ([\w.]+)/,i=/(mozilla)(?:.*? rv:([\w.]+))?/,o=t.exec(e)||n.exec(e)||r.exec(e)||0>e.indexOf("compatible")&&i.exec(e)||[];return{browser:o[1]||"",version:o[2]||"0"}}(),Viva.Graph.Utils=Viva.Graph.Utils||{},Viva.Graph.Utils.indexOfElementInArray=function(e,t){if(t.indexOf)return t.indexOf(e);var n,r=t.length;for(n=0;r>n;n+=1)if(t.hasOwnProperty(n)&&t[n]===e)return n;return-1},Viva.Graph.Utils=Viva.Graph.Utils||{},Viva.Graph.Utils.getDimension=function(e){if(!e)throw{message:"Cannot get dimensions of undefined container"};var t=e.clientWidth,n=e.clientHeight;return{left:0,top:0,width:t,height:n}},Viva.Graph.Utils.findElementPosition=function(e){var t=0,n=0;if(e.offsetParent)do t+=e.offsetLeft,n+=e.offsetTop;while(null!==(e=e.offsetParent));return[t,n]},Viva.Graph.Utils=Viva.Graph.Utils||{},Viva.Graph.Utils.events=function(e){var t=function(e){var t={};return e.fire=function(e,n){var r,i,o,a;if("string"!=typeof e)throw"Only strings can be used as even type";if(t.hasOwnProperty(e))for(r=t[e],a=0;r.length>a;++a)o=r[a],i=o.method,i(n);return this},e.addEventListener=function(e,n){if("function"!=typeof n)throw"Only functions allowed to be callbacks";var r={method:n};return t.hasOwnProperty(e)?t[e].push(r):t[e]=[r],this},e.removeEventListener=function(e,n){if("function"!=typeof n)throw"Only functions allowed to be callbacks";if(t.hasOwnProperty(e)){var r,i=t[e];for(r=0;i.length>r;++r)if(i[r].callback===n){i.splice(r);break}}return this},e.removeAllListeners=function(){var e;for(e in t)t.hasOwnProperty(e)&&delete t[e]},e};return{on:function(t,n){return e.addEventListener?e.addEventListener(t,n,!1):e.attachEvent&&e.attachEvent("on"+t,n),this},stop:function(t,n){e.removeEventListener?e.removeEventListener(t,n,!1):e.detachEvent&&e.detachEvent("on"+t,n)},extend:function(){return t(e)}}},Viva.Graph.Utils=Viva.Graph.Utils||{},Viva.Graph.Utils.dragndrop=function(e){var t,n,r,i,o,a,u,s=Viva.Graph.Utils.events(window.document),f=Viva.Graph.Utils.events(e),c=Viva.Graph.Utils.findElementPosition,d=0,l=0,h=!1,v=0,p=function(e){var t=0,n=0;return e=e||window.event,e.pageX||e.pageY?(t=e.pageX,n=e.pageY):(e.clientX||e.clientY)&&(t=e.clientX+window.document.body.scrollLeft+window.document.documentElement.scrollLeft,n=e.clientY+window.document.body.scrollTop+window.document.documentElement.scrollTop),[t,n]},m=function(e,t,r){n&&n(e,{x:t-d,y:r-l}),d=t,l=r},g=function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0},y=function(e){e.preventDefault&&e.preventDefault()},x=function(e){return g(e),!1},w=function(e){e=e||window.event,m(e,e.clientX,e.clientY)},V=function(e){if(e=e||window.event,h)return g(e),!1;var n=1===e.button&&null!==window.event||0===e.button;return n?(d=e.clientX,l=e.clientY,u=e.target||e.srcElement,t&&t(e,{x:d,y:l}),s.on("mousemove",w),s.on("mouseup",b),g(e),o=window.document.onselectstart,a=window.document.ondragstart,window.document.onselectstart=x,u.ondragstart=x,!1):void 0},b=function(e){e=e||window.event,s.stop("mousemove",w),s.stop("mouseup",b),window.document.onselectstart=o,u.ondragstart=a,u=null,r&&r(e)},N=function(t){if("function"==typeof i){t=t||window.event,t.preventDefault&&t.preventDefault(),t.returnValue=!1;var n,r=p(t),o=c(e),a={x:r[0]-o[0],y:r[1]-o[1]};n=t.wheelDelta?t.wheelDelta/360:t.detail/-9,i(t,n,a)}},P=function(t){!i&&t?"webkit"===Viva.BrowserInfo.browser?e.addEventListener("mousewheel",N,!1):e.addEventListener("DOMMouseScroll",N,!1):i&&!t&&("webkit"===Viva.BrowserInfo.browser?e.removeEventListener("mousewheel",N,!1):e.removeEventListener("DOMMouseScroll",N,!1)),i=t},E=function(e,t){return(e.clientX-t.clientX)*(e.clientX-t.clientX)+(e.clientY-t.clientY)*(e.clientY-t.clientY)},G=function(e){if(1===e.touches.length){g(e);var t=e.touches[0];m(e,t.clientX,t.clientY)}else if(2===e.touches.length){var n=E(e.touches[0],e.touches[1]),r=0;v>n?r=-1:n>v&&(r=1),i(e,r,{x:e.touches[0].clientX,y:e.touches[0].clientY}),v=n,g(e),y(e)}},L=function(e){h=!1,s.stop("touchmove",G),s.stop("touchend",L),s.stop("touchcancel",L),u=null,r&&r(e)},_=function(e,n){g(e),y(e),d=n.clientX,l=n.clientY,u=e.target||e.srcElement,t&&t(e,{x:d,y:l}),h||(h=!0,s.on("touchmove",G),s.on("touchend",L),s.on("touchcancel",L))},A=function(t){return console.log("Touch start for ",e),1===t.touches.length?_(t,t.touches[0]):(2===t.touches.length&&(g(t),y(t),v=E(t.touches[0],t.touches[1])),void 0)};return f.on("mousedown",V),f.on("touchstart",A),{onStart:function(e){return t=e,this},onDrag:function(e){return n=e,this},onStop:function(e){return r=e,this},onScroll:function(e){return P(e),this},release:function(){s.stop("mousemove",w),s.stop("mousedown",V),s.stop("mouseup",b),s.stop("touchmove",G),s.stop("touchend",L),s.stop("touchcancel",L),P(null)}}},Viva.Input=Viva.Input||{},Viva.Input.domInputManager=function(e,t){var n={};return{bindDragNDrop:function(e,r){var i;if(r){var o=t.getNodeUI(e.id);i=Viva.Graph.Utils.dragndrop(o),"function"==typeof r.onStart&&i.onStart(r.onStart),"function"==typeof r.onDrag&&i.onDrag(r.onDrag),"function"==typeof r.onStop&&i.onStop(r.onStop),n[e.id]=i}else(i=n[e.id])&&(i.release(),delete n[e.id])}}},Viva.Graph.Utils=Viva.Graph.Utils||{},function(){var e,t,n=0,r=["ms","moz","webkit","o"];for(t="undefined"!=typeof window?window:"undefined"!=typeof global?global:{setTimeout:function(){},clearTimeout:function(){}},e=0;r.length>e&&!t.requestAnimationFrame;++e){var i=r[e];t.requestAnimationFrame=t[i+"RequestAnimationFrame"],t.cancelAnimationFrame=t[i+"CancelAnimationFrame"]||t[i+"CancelRequestAnimationFrame"]}t.requestAnimationFrame||(t.requestAnimationFrame=function(e){var r=(new Date).getTime(),i=Math.max(0,16-(r-n)),o=t.setTimeout(function(){e(r+i)},i);return n=r+i,o}),t.cancelAnimationFrame||(t.cancelAnimationFrame=function(e){t.clearTimeout(e)}),Viva.Graph.Utils.timer=function(e){var n,r=function(){t.cancelAnimationFrame(n),n=0},i=function(){n=t.requestAnimationFrame(i),e()||r()};return i(),{stop:r,restart:function(){n||i()}}}}(),Viva.Graph.geom=function(){return{intersect:function(e,t,n,r,i,o,a,u){var s,f,c,d,l,h,v,p,m,g,y,x,w,V={x:0,y:0};return s=r-t,c=e-n,l=n*t-e*r,m=s*i+c*o+l,g=s*a+c*u+l,0!==m&&0!==g&&m>=0==g>=4?null:(f=u-o,d=i-a,h=a*o-i*u,v=f*e+d*t+h,p=f*n+d*r+h,0!==v&&0!==p&&v>=0==p>=0?null:(y=s*d-f*c,0===y?null:(x=0>y?-y/2:y/2,x=0,w=c*h-d*l,V.x=(0>w?w-x:w+x)/y,w=f*l-s*h,V.y=(0>w?w-x:w+x)/y,V)))},intersectRect:function(e,t,n,r,i,o,a,u){return this.intersect(e,t,e,r,i,o,a,u)||this.intersect(e,r,n,r,i,o,a,u)||this.intersect(n,r,n,t,i,o,a,u)||this.intersect(n,t,e,t,i,o,a,u)},convexHull:function(e){var t=function(e,t){var n,r,i=function(t){var n=t.x-e.x,r=t.y-e.y,i=n>0?1:-1;return i*n*n/(n*n+r*r)},o=t.sort(function(e,t){return i(t)-i(e)}),a=o[0],u=i(a),s=a.x-e.x,f=a.y-e.y,c=s*s+f*f;for(r=1;o.length>r;++r){a=o[r];var d=i(a);d===u?(s=a.x-e.x,f=a.y-e.y,n=s*s+f*f,c>n?o.splice(r,1):o.splice(r-1,1)):u=d}return o},n=function(e,t,n){return 0>(n.x-e.x)*(t.y-e.y)-(n.y-e.y)*(t.x-e.x)};if(3>e.length)return e;var r,i=0;for(r=0;e.length>r;++r)e[r].y<e[i].y?i=r:e[r].y===e[i].y&&e[r].x<e[i].x&&(i=r);var o=e[i];e.splice(i,1);var a=t(o,e);if(2>a.length)return a;var u=[];u.push(o),u.push(a[0]),u.push(a[1]);var s=u.length;for(r=2;a.length>r;++r){for(;!n(u[s-2],u[s-1],a[r]);)u.pop(),s-=1;u.push(a[r]),s+=1}return u}}},Viva.Graph.Rect=function(e,t,n,r){this.x1=e||0,this.y1=t||0,this.x2=n||0,this.y2=r||0},Viva.Graph.Point2d=function(e,t){this.x=e||0,this.y=t||0},Viva.Graph.Node=function(e){this.id=e,this.links=[],this.data=null},Viva.Graph.Link=function(e,t,n,r){this.fromId=e,this.toId=t,this.data=n,this.id=r},Viva.Graph.graph=function(){var e="function"==typeof Object.create?Object.create(null):{},t=[],n={},r=0,i=0,o=[],a=function(e){e.fire("changed",o)},u=function(){i+=1},s=function(e){i-=1,0===i&&o.length>0&&(a(e),o.length=0)},f=function(e,t){o.push({node:e,changeType:t})},c=function(e,t){o.push({link:e,changeType:t})},d={addNode:function(t,n){if(t===void 0)throw{message:"Invalid node identifier"};u();var i=this.getNode(t);return i?f(i,"update"):(i=new Viva.Graph.Node(t),r++,f(i,"add")),i.data=n,e[t]=i,s(this),i},addLink:function(e,r,i){u();var o=this.getNode(e)||this.addNode(e),a=this.getNode(r)||this.addNode(r),f=""+e+"ðŸ‘‰ "+(""+r),d=n.hasOwnProperty(f);(d||this.hasLink(e,r))&&(d||(n[f]=0),f+="@"+ ++n[f]);var l=new Viva.Graph.Link(e,r,i,f);return t.push(l),o.links.push(l),a.links.push(l),c(l,"add"),s(this),l},removeLink:function(e){if(!e)return!1;var n=Viva.Graph.Utils.indexOfElementInArray(e,t);if(0>n)return!1;u(),t.splice(n,1);var r=this.getNode(e.fromId),i=this.getNode(e.toId);return r&&(n=Viva.Graph.Utils.indexOfElementInArray(e,r.links),n>=0&&r.links.splice(n,1)),i&&(n=Viva.Graph.Utils.indexOfElementInArray(e,i.links),n>=0&&i.links.splice(n,1)),c(e,"remove"),s(this),!0},removeNode:function(t){var n=this.getNode(t);if(!n)return!1;for(u();n.links.length;){var i=n.links[0];this.removeLink(i)}e[t]=null,delete e[t],r--,f(n,"remove"),s(this)},getNode:function(t){return e[t]},getNodesCount:function(){return r},getLinksCount:function(){return t.length},getLinks:function(e){var t=this.getNode(e);return t?t.links:null},forEachNode:function(t){if("function"==typeof t){var n;for(n in e)if(t(e[n]))return}},forEachLinkedNode:function(t,n,r){var i,o,a,u=this.getNode(t);if(u&&u.links&&"function"==typeof n)if(r)for(i=0;u.links.length>i;++i)o=u.links[i],o.fromId===t&&n(e[o.toId],o);else for(i=0;u.links.length>i;++i)o=u.links[i],a=o.fromId===t?o.toId:o.fromId,n(e[a],o)},forEachLink:function(e){var n,r;if("function"==typeof e)for(n=0,r=t.length;r>n;++n)e(t[n])},beginUpdate:function(){u()},endUpdate:function(){s(this)},clear:function(){var e=this;e.beginUpdate(),e.forEachNode(function(t){e.removeNode(t.id)}),e.endUpdate()},hasLink:function(e,t){var n,r=this.getNode(e);if(!r)return null;for(n=0;r.links.length>n;++n){var i=r.links[n];if(i.fromId===e&&i.toId===t)return i}return null}};return Viva.Graph.Utils.events(d).extend(),d},Viva.Graph.operations=function(){return{density:function(e,t){var n=e.getNodesCount();return 0===n?0/0:t?e.getLinksCount()/(n*(n-1)):2*e.getLinksCount()/(n*(n-1))}}},Viva.Graph.Physics=Viva.Graph.Physics||{},Viva.Graph.Physics.Vector=function(e,t){this.x=e||0,this.y=t||0},Viva.Graph.Physics.Vector.prototype={multiply:function(e){return new Viva.Graph.Physics.Vector(this.x*e,this.y*e)}},Viva.Graph.Physics.Point=function(e,t){this.x=e||0,this.y=t||0},Viva.Graph.Physics.Point.prototype={add:function(e){return new Viva.Graph.Physics.Point(this.x+e.x,this.y+e.y)}},Viva.Graph.Physics.Body=function(){this.mass=1,this.force=new Viva.Graph.Physics.Vector,this.velocity=new Viva.Graph.Physics.Vector,this.location=new Viva.Graph.Physics.Point,this.prevLocation=new Viva.Graph.Physics.Point},Viva.Graph.Physics.Body.prototype={loc:function(e){return e?(this.location.x=e.x,this.location.y=e.y,this):this.location},vel:function(e){return e?(this.velocity.x=e.x,this.velocity.y=e.y,this):this.velocity}},Viva.Graph.Physics.Spring=function(e,t,n,r,i){this.body1=e,this.body2=t,this.length=n,this.coeff=r,this.weight=i},Viva.Graph.Physics.QuadTreeNode=function(){this.centerOfMass=new Viva.Graph.Physics.Point,this.children=[],this.body=null,this.hasChildren=!1,this.x1=0,this.y1=0,this.x2=0,this.y2=0},Viva.Graph.Physics=Viva.Graph.Physics||{},Viva.Graph.Physics.eulerIntegrator=function(){return{integrate:function(e,t){var n,r=e.speedLimit,i=0,o=0,a=e.bodies.length;for(n=0;a>n;++n){var u=e.bodies[n],s=t/u.mass;u.velocity.x+=s*u.force.x,u.velocity.y+=s*u.force.y;var f=u.velocity.x,c=u.velocity.y,d=Math.sqrt(f*f+c*c);d>r&&(u.velocity.x=r*f/d,u.velocity.y=r*c/d),i=t*u.velocity.x,o=t*u.velocity.y,u.location.x+=i,u.location.y+=o}return i*i+o*o}}},Viva.Graph.Physics.nbodyForce=function(e){function t(e,t){this.node=e,this.body=t}function n(){this.stack=[],this.popIdx=0}e=Viva.lazyExtend(e||{gravity:-1,theta:.8}),n.prototype={isEmpty:function(){return 0===this.popIdx},push:function(e,n){var r=this.stack[this.popIdx];r?(r.node=e,r.body=n):this.stack[this.popIdx]=new t(e,n),++this.popIdx},pop:function(){return this.popIdx>0?this.stack[--this.popIdx]:void 0},reset:function(){this.popIdx=0}};var r=e.gravity,i=[],o=new n,a=e.theta,u=Viva.random("5f4dcc3b5aa765d61d8327deb882cf99",75,20,63,108,65,76,65,72),s=function(){this.body=null,this.quads=[],this.mass=0,this.massX=0,this.massY=0,this.left=0,this.top=0,this.bottom=0,this.right=0,this.isInternal=!1},f=[],c=0,d=function(){var e;return f[c]?(e=f[c],e.quads[0]=null,e.quads[1]=null,e.quads[2]=null,e.quads[3]=null,e.body=null,e.mass=e.massX=e.massY=0,e.left=e.right=e.top=e.bottom=0,e.isInternal=!1):(e=new s,f[c]=e),++c,e},l=d(),h=function(e,t){var n=Math.abs(e.x-t.x),r=Math.abs(e.y-t.y);return 1e-8>n&&1e-8>r},v=function(e){for(o.reset(),o.push(l,e);!o.isEmpty();){var t=o.pop(),n=t.node,r=t.body;if(n.isInternal){var i=r.location.x,a=r.location.y;n.mass=n.mass+r.mass,n.massX=n.massX+r.mass*i,n.massY=n.massY+r.mass*a;var s=0,f=n.left,c=(n.right+f)/2,v=n.top,p=(n.bottom+v)/2;if(i>c){s+=1;var m=f;f=c,c+=c-m}if(a>p){s+=2;var g=v;v=p,p+=p-g}var y=n.quads[s];y||(y=d(),y.left=f,y.top=v,y.right=c,y.bottom=p,n.quads[s]=y),o.push(y,r)}else if(n.body){var x=n.body;if(n.body=null,n.isInternal=!0,h(x.location,r.location)){if(1e-8>n.right-n.left)return;do{var w=u.nextDouble(),V=(n.right-n.left)*w,b=(n.bottom-n.top)*w;x.location.x=n.left+V,x.location.y=n.top+b}while(h(x.location,r.location))}o.push(n,x),o.push(n,r)}else n.body=r}},p=function(e){var t,n,o,s,f=i,c=1,d=0,h=1;for(f[0]=l;c;){var v=f[d],p=v.body;c-=1,d+=1,p&&p!==e?(n=p.location.x-e.location.x,o=p.location.y-e.location.y,s=Math.sqrt(n*n+o*o),0===s&&(n=(u.nextDouble()-.5)/50,o=(u.nextDouble()-.5)/50,s=Math.sqrt(n*n+o*o)),t=r*p.mass*e.mass/(s*s*s),e.force.x=e.force.x+t*n,e.force.y=e.force.y+t*o):(n=v.massX/v.mass-e.location.x,o=v.massY/v.mass-e.location.y,s=Math.sqrt(n*n+o*o),0===s&&(n=(u.nextDouble()-.5)/50,o=(u.nextDouble()-.5)/50,s=Math.sqrt(n*n+o*o)),a>(v.right-v.left)/s?(t=r*v.mass*e.mass/(s*s*s),e.force.x=e.force.x+t*n,e.force.y=e.force.y+t*o):(v.quads[0]&&(f[h]=v.quads[0],c+=1,h+=1),v.quads[1]&&(f[h]=v.quads[1],c+=1,h+=1),v.quads[2]&&(f[h]=v.quads[2],c+=1,h+=1),v.quads[3]&&(f[h]=v.quads[3],c+=1,h+=1)))}},m=function(e){var t,n=Number.MAX_VALUE,r=Number.MAX_VALUE,i=Number.MIN_VALUE,o=Number.MIN_VALUE,a=e.bodies,u=a.length;for(t=u;t--;){var s=a[t].location.x,f=a[t].location.y;n>s&&(n=s),s>i&&(i=s),r>f&&(r=f),f>o&&(o=f)}var h=i-n,p=o-r;for(h>p?o=r+h:i=n+p,c=0,l=d(),l.left=n,l.right=i,l.top=r,l.bottom=o,t=u;t--;)v(a[t],l)};return{insert:v,init:m,update:p,options:function(e){return e?("number"==typeof e.gravity&&(r=e.gravity),"number"==typeof e.theta&&(a=e.theta),this):{gravity:r,theta:a}}}},Viva.Graph.Physics.dragForce=function(e){e||(e={});var t={coeff:e.coeff||.01};return{update:function(e){e.force.x-=t.coeff*e.velocity.x,e.force.y-=t.coeff*e.velocity.y},options:function(e){return e?("number"==typeof e.coeff&&(t.coeff=e.coeff),this):t}}},Viva.Graph.Physics.springForce=function(e){e=Viva.lazyExtend(e,{length:50,coeff:22e-5});var t=Viva.random("Random number 4.","Chosen by fair dice roll");return{update:function(n){var r=n.body1,i=n.body2,o=0>n.length?e.length:n.length,a=i.location.x-r.location.x,u=i.location.y-r.location.y,s=Math.sqrt(a*a+u*u);0===s&&(a=(t.nextDouble()-.5)/50,u=(t.nextDouble()-.5)/50,s=Math.sqrt(a*a+u*u));var f=s-o,c=(!n.coeff||0>n.coeff?e.coeff:n.coeff)*f/s*n.weight;r.force.x+=c*a,r.force.y+=c*u,i.force.x+=-c*a,i.force.y+=-c*u},options:function(t){return t?("number"==typeof t.length&&(e.length=t.length),"number"==typeof t.coeff&&(e.coeff=t.coeff),this):e}}},Viva.Graph.Physics=Viva.Graph.Physics||{},Viva.Graph.Physics.forceSimulator=function(e){var t,n,r,i=e,o=[],a=[];return{speedLimit:1,bodies:o,accumulate:function(){var e,i;for(n.init(this),e=o.length;e--;)i=o[e],i.force.x=0,i.force.y=0,n.update(i),r.update(i);for(e=a.length;e--;)t.update(a[e])},run:function(e){return this.accumulate(),i.integrate(this,e)},addBody:function(e){if(!e)throw{message:"Cannot add null body to force simulator"};return o.push(e),e},removeBody:function(e){if(!e)return!1;var t=Viva.Graph.Utils.indexOfElementInArray(e,o);return 0>t?!1:o.splice(t,1)},addSpring:function(e,t,n,r,i){if(!e||!t)throw{message:"Cannot add null spring to force simulator"};if("number"!=typeof n)throw{message:"Spring length should be a number"};r="number"==typeof r?r:1;var o=new Viva.Graph.Physics.Spring(e,t,n,i>=0?i:-1,r);return a.push(o),o},removeSpring:function(e){if(!e)return!1;var t=Viva.Graph.Utils.indexOfElementInArray(e,a);return 0>t?!1:a.splice(t,1)},setNbodyForce:function(e){if(!e)throw{message:"Cannot add mighty (unknown) force to the simulator"};n=e},setDragForce:function(e){if(!e)throw{message:"Cannot add mighty (unknown) force to the simulator"};r=e},setSpringForce:function(e){if(!e)throw{message:"Cannot add unknown force to the simulator"};t=e}}},Viva.Graph.Layout=Viva.Graph.Layout||{},Viva.Graph.Layout.forceDirected=function(e,t){if(!e)throw{message:"Graph structure cannot be undefined"};t=Viva.lazyExtend(t,{springLength:80,springCoeff:2e-4,gravity:-1.2,theta:.8,dragCoeff:.02,springTransform:function(){},timeStep:20,stableThreshold:.001});var n=Viva.Graph.Physics.forceSimulator(Viva.Graph.Physics.eulerIntegrator()),r=Viva.Graph.Physics.nbodyForce({gravity:t.gravity,theta:t.theta}),i=Viva.Graph.Physics.springForce({length:t.springLength,coeff:t.springCoeff}),o=Viva.Graph.Physics.dragForce({coeff:t.dragCoeff}),a=new Viva.Graph.Rect,u=Viva.random("ted.com",103,114,101,97,116),s={},f=function(e){if(e.position)return e.position;var n=(a.x1+a.x2)/2,r=(a.y1+a.y2)/2,i=t.springLength;if(e.links&&e.links.length>0){var o=e.links[0],f=o.fromId!==e.id?s[o.fromId]:s[o.toId];f&&f.location&&(n=f.location.x,r=f.location.y)}return{x:n+u.next(i)-i/2,y:r+u.next(i)-i/2}},c=function(e){return s[e]},d=function(e){s[e]=null,delete s[e]},l={},h=function(t){var n=c(t);n.mass=1+e.getLinks(t).length/3},v=function(e){return e&&(e.isPinned||e.data&&e.data.isPinned)},p=function(e){return e.isPinned},m=function(t){var r=c(t);if(!r){var i=e.getNode(t);if(!i)return;r=new Viva.Graph.Physics.Body,s[t]=r;var o=f(i);r.loc(o),h(t),v(i)&&(r.isPinned=!0),n.addBody(r)}},g=function(e){m(e.id)},y=function(t){var r=c(t.id);r&&(d(t.id),n.removeBody(r),0===e.getNodesCount()&&(a.x1=a.y1=0,a.x2=a.y2=0))},x=function(e){h(e.fromId),h(e.toId);var r=c(e.fromId),i=c(e.toId),o=n.addSpring(r,i,-1,e.weight);t.springTransform(e,o),l[e.id]=o},w=function(t){var r=l[t.id];if(r){var i=e.getNode(t.fromId),o=e.getNode(t.toId);i&&h(i.id),o&&h(o.id),delete l[t.id],n.removeSpring(r)}},V=function(e){for(var t=0;e.length>t;++t){var n=e[t];"add"===n.changeType?(n.node&&m(n.node.id),n.link&&x(n.link)):"remove"===n.changeType&&(n.node&&y(n.node),n.link&&w(n.link))}},b=function(){e.forEachNode(g),e.forEachLink(x),e.addEventListener("changed",V)},N=function(){var t=Number.MAX_VALUE,n=Number.MAX_VALUE,r=Number.MIN_VALUE,i=Number.MIN_VALUE;if(0!==e.getNodesCount()){for(var o in s)if(s.hasOwnProperty(o)){var u=s[o];p(u)?(u.location.x=u.prevLocation.x,u.location.y=u.prevLocation.y):(u.prevLocation.x=u.location.x,u.prevLocation.y=u.location.y),t>u.location.x&&(t=u.location.x),u.location.x>r&&(r=u.location.x),n>u.location.y&&(n=u.location.y),u.location.y>i&&(i=u.location.y)}a.x1=t,a.x2=r,a.y1=n,a.y2=i}};return n.setSpringForce(i),n.setNbodyForce(r),n.setDragForce(o),b(),{run:function(e){var t;for(e=e||50,t=0;e>t;++t)this.step()},step:function(){var e=n.run(t.timeStep);return N(),t.stableThreshold>e},isNodePinned:function(e){var t=c(e.id);return t?p(t):void 0},pinNode:function(e,t){var n=c(e.id);n.isPinned=!!t},getNodePosition:function(e){var t=c(e);return t||(m(e),t=c(e)),t&&t.location},getLinkPosition:function(e){var t=this.getNodePosition(e.fromId),n=this.getNodePosition(e.toId);return{from:t,to:n}},setNodePosition:function(e,t,n){var r=c(e.id);r&&(r.prevLocation.x=r.location.x=t,r.prevLocation.y=r.location.y=n)},getGraphRect:function(){return a},dispose:function(){e.removeEventListener("change",V)},springLength:function(e){return 1===arguments.length?(i.options({length:e}),this):i.options().length},springCoeff:function(e){return 1===arguments.length?(i.options({coeff:e}),this):i.options().coeff},gravity:function(e){return 1===arguments.length?(r.options({gravity:e}),this):r.options().gravity},theta:function(e){return 1===arguments.length?(r.options({theta:e}),this):r.options().theta},drag:function(e){return 1===arguments.length?(o.options({coeff:e}),this):o.options().coeff}}},Viva.Graph.Layout=Viva.Graph.Layout||{},Viva.Graph.Layout.constant=function(e,t){t=Viva.lazyExtend(t,{maxX:1024,maxY:1024,seed:"Deterministic randomness made me do this"});var n=Viva.random(t.seed),r=new Viva.Graph.Rect(Number.MAX_VALUE,Number.MAX_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),i=function(){return new Viva.Graph.Point2d(n.next(t.maxX),n.next(t.maxY))},o=function(e,t){e.x<t.x1&&(t.x1=e.x),e.x>t.x2&&(t.x2=e.x),e.y<t.y1&&(t.y1=e.y),e.y>t.y2&&(t.y2=e.y)},a="function"==typeof Object.create?Object.create(null):{},u=function(e){e&&(a[e.id]=i(e),o(a[e.id],r))},s=function(){0!==e.getNodesCount()&&(r.x1=Number.MAX_VALUE,r.y1=Number.MAX_VALUE,r.x2=Number.MIN_VALUE,r.y2=Number.MIN_VALUE,e.forEachNode(u))},f=function(e){for(var t=0;e.length>t;++t){var n=e[t];n.node&&("add"===n.changeType?u(n.node):delete a[n.node.id])}};return e.addEventListener("changed",f),{run:function(){this.step()},step:function(){return s(),!0},getGraphRect:function(){return r},dispose:function(){e.removeEventListener("change",f)},isNodePinned:function(){return!0},pinNode:function(){},getNodePosition:function(t){var n=a[t];return n||u(e.getNode(t)),n},getLinkPosition:function(e){var t=this.getNodePosition(e.fromId),n=this.getNodePosition(e.toId);return{from:t,to:n}},setNodePosition:function(e,t,n){var r=a[e.id];r&&(r.x=t,r.y=n)},placeNode:function(e){return"function"==typeof e?(i=e,s(),this):i(e)}}},Viva.Graph.View=Viva.Graph.View||{},Viva.Graph.View.renderer=function(e,t){var n=30;t=t||{};var r,i,o,a,u=t.layout,s=t.graphics,f=t.container,c=void 0!==t.interactive?t.interactive:!0,d=!1,l=!0,h=0,v=0,p=!1,m=!1,g={x:0,y:0},y={offsetX:0,offsetY:0,scale:1},x=function(){f=f||window.document.body,u=u||Viva.Graph.Layout.forceDirected(e),s=s||Viva.Graph.View.svgGraphics(e,{container:f}),t.hasOwnProperty("renderLinks")||(t.renderLinks=!0),t.prerender=t.prerender||0,r=(s.inputManager||Viva.Input.domInputManager)(e,s)},w=Viva.Graph.Utils.events(window),V=Viva.Graph.Utils.events({}).extend(),b=function(){s.beginRender(),t.renderLinks&&s.renderLinks(),s.renderNodes(),s.endRender()},N=function(){return p=u.step()&&!m,b(),!p},P=function(e){return i?(v+=e,void 0):(e?(v+=e,i=Viva.Graph.Utils.timer(function(){return N()},n)):(h=0,v=0,i=Viva.Graph.Utils.timer(N,n)),void 0)},E=function(){p=!1,i.restart()},G=function(){var e;if("number"==typeof t.prerender&&t.prerender>0)for(e=0;t.prerender>e;e+=1)u.step()},L=function(){var e=u.getGraphRect(),t=Viva.Graph.Utils.getDimension(f);g.x=g.y=0,y.offsetX=t.width/2-(e.x2+e.x1)/2,y.offsetY=t.height/2-(e.y2+e.y1)/2,s.graphCenterChanged(y.offsetX,y.offsetY),l=!1},_=function(e){var t=u.getNodePosition(e.id);s.addNode(e,t)},A=function(e){s.releaseNode(e)},I=function(e){var t=u.getLinkPosition(e);s.addLink(e,t)},k=function(e){s.releaseLink(e)},T=function(e){var t=!1,n="string"==typeof c&&-1!==c.indexOf("node")||c;n&&r.bindDragNDrop(e,{onStart:function(){t=u.isNodePinned(e),u.pinNode(e,!0),m=!0,E()},onDrag:function(t,n){var r=u.getNodePosition(e.id);u.setNodePosition(e,r.x+n.x/y.scale,r.y+n.y/y.scale),m=!0,b()},onStop:function(){u.pinNode(e,t),m=!1}})},C=function(e){r.bindDragNDrop(e,null)},S=function(){s.init(f),e.forEachNode(_),t.renderLinks&&e.forEachLink(I)},M=function(){s.release(f)},U=function(t){var n=t.node;"add"===t.changeType?(_(n),T(n),l&&L()):"remove"===t.changeType?(C(n),A(n),0===e.getNodesCount()&&(l=!0)):"update"===t.changeType&&(C(n),A(n),_(n),T(n))},D=function(e){var n=e.link;if("add"===e.changeType)t.renderLinks&&I(n);else if("remove"===e.changeType)t.renderLinks&&k(n);else if("update"===e.changeType)throw"Update type is not implemented. TODO: Implement me!"},R=function(e){var t,n;for(t=0;e.length>t;t+=1)n=e[t],n.node?U(n):n.link&&D(n);E()},O=function(){L(),N()},F=function(){a&&(a.release(),a=null)},z=function(){o&&(o.stop("changed",R),o=null)},B=function(e,t){if(!t){var n=Viva.Graph.Utils.getDimension(f);t={x:n.width/2,y:n.height/2}}var r=Math.pow(1.4,e?-.2:.2);y.scale=s.scale(r,t),b(),V.fire("scale",y.scale)},Y=function(){w.on("resize",O),F();var t="string"==typeof c&&-1!==c.indexOf("drag")||c;t&&(a=Viva.Graph.Utils.dragndrop(f),a.onDrag(function(e,t){g.x+=t.x,g.y+=t.y,s.translateRel(t.x,t.y),b()}));var n="string"==typeof c&&-1!==c.indexOf("scroll")||c;n&&a.onScroll(function(e,t,n){B(0>t,n)}),e.forEachNode(T),z(),o=Viva.Graph.Utils.events(e),o.on("changed",R)},X=function(){d=!1,z(),F(),w.stop("resize",O),V.removeAllListeners(),i.stop(),e.forEachLink(function(e){t.renderLinks&&k(e)}),e.forEachNode(function(e){C(e),A(e)}),u.dispose(),M()};return{run:function(e){return d||(x(),G(),L(),S(),Y(),d=!0),P(e),this},reset:function(){s.resetScale(),L(),y.scale=1},pause:function(){i.stop()},resume:function(){i.restart()},rerender:function(){return b(),this},zoomOut:function(){B(!0)},zoomIn:function(){B(!1)},moveTo:function(e,t){s.graphCenterChanged(y.offsetX-e*y.scale,y.offsetY-t*y.scale),b()},getGraphics:function(){return s},dispose:function(){X()},on:function(e,t){return V.addEventListener(e,t),this},off:function(e,t){return V.removeEventListener(e,t),this}}},Viva.Graph.serializer=function(){var e=function(){if("undefined"==typeof JSON||!JSON.stringify||!JSON.parse)throw"JSON serializer is not defined."},t=function(e){return{id:e.id,data:e.data}},n=function(e){return{fromId:e.fromId,toId:e.toId,data:e.data}},r=function(e){return e},i=function(e){return e};return{storeToJSON:function(r,i,o){if(!r)throw"Graph is not defined";e(),i=i||t,o=o||n;var a={nodes:[],links:[]};return r.forEachNode(function(e){a.nodes.push(i(e))}),r.forEachLink(function(e){a.links.push(o(e))}),JSON.stringify(a)},loadFromJSON:function(t,n,o){if("string"!=typeof t)throw"String expected in loadFromJSON() method";e(),n=n||r,o=o||i;var a,u=JSON.parse(t),s=Viva.Graph.graph();if(!u||!u.nodes||!u.links)throw"Passed json string does not represent valid graph";for(a=0;u.nodes.length>a;++a){var f=n(u.nodes[a]);if(!f.hasOwnProperty("id"))throw"Graph node format is invalid. Node.id is missing";s.addNode(f.id,f.data)}for(a=0;u.links.length>a;++a){var c=o(u.links[a]);if(!c.hasOwnProperty("fromId")||!c.hasOwnProperty("toId"))throw"Graph link format is invalid. Both fromId and toId are required";s.addLink(c.fromId,c.toId,c.data)}return s}}},Viva.Graph.centrality=function(){var e=function(e,t,n){var r,i,o,a={},u=[],s={},f={},c=[t.id],d=function(e){f.hasOwnProperty(e.id)||(c.push(e.id),f[e.id]=i+1),f[e.id]===i+1&&(s[e.id]+=o,a[e.id].push(r))};for(e.forEachNode(function(e){a[e.id]=[],s[e.id]=0}),f[t.id]=0,s[t.id]=1;c.length;)r=c.shift(),i=f[r],o=s[r],u.push(r),e.forEachLinkedNode(r,d,n);return{S:u,P:a,sigma:s}},t=function(e,t,n){var r,i,o,a,u,s={},f=t.S;for(r=0;f.length>r;r+=1)s[f[r]]=0;for(;f.length;){for(i=f.pop(),o=(1+s[i])/t.sigma[i],a=t.P[i],r=0;a.length>r;r+=1)u=a[r],s[u]+=t.sigma[u]*o;i!==n&&(e[i]+=s[i])}},n=function(e){var t,n=[];for(t in e)e.hasOwnProperty(t)&&n.push({key:t,value:e[t]});return n.sort(function(e,t){return t.value-e.value})};return{betweennessCentrality:function(r){var i,o={};return r.forEachNode(function(e){o[e.id]=0}),r.forEachNode(function(n){i=e(r,n),t(o,i,n)}),n(o)},degreeCentrality:function(e,t){var n,r,i=[],o=[];if(t=(t||"both").toLowerCase(),"in"===t)n=function(e,t){var n,r=0;for(n=0;e.length>n;n+=1)r+=e[n].toId===t?1:0;return r};else if("out"===t)n=function(e,t){var n,r=0;for(n=0;e.length>n;n+=1)r+=e[n].fromId===t?1:0;return r};else{if("both"!==t)throw"Expected centrality degree kind is: in, out or both";n=function(e){return e.length}}e.forEachNode(function(t){var r=e.getLinks(t.id),o=n(r,t.id);i.hasOwnProperty(o)?i[o].push(t.id):i[o]=[t.id]});for(r in i)if(i.hasOwnProperty(r)){var a,u=i[r];if(u)for(a=0;u.length>a;++a)o.unshift({key:u[a],value:parseInt(r,10)})}return o}}},Viva.Graph.community=function(){return{slpa:function(e,t,n){var r=Viva.Graph._community.slpaAlgorithm(e,t,n);return r.run()}}},Viva.Graph._community={},Viva.Graph._community.slpaAlgorithm=function(e,t,n){t=t||100,n=n||.3;var r=Viva.random(1331782216905),i=Viva.random("Greeting goes to you, ","dear reader"),o=function(e,n){var r=[];return e.forEachUniqueWord(function(e,i){return i>n?(r.push({name:e,probability:i/t}),void 0):!0}),r},a=function(e){var t=[];return e.forEachNode(function(e){var n=Viva.Graph._community.occuranceMap(r);n.add(e.id),e.slpa={memory:n},t.push(e.id)}),t},u=function(e,n){var o,a=Viva.randomIterator(n,i),u=function(t){var n=e.getNode(t),i=Viva.Graph._community.occuranceMap(r);e.forEachLinkedNode(t,function(e){var t=e.slpa.memory.getRandomWord();i.add(t)});var o=i.getMostPopularFair();n.slpa.memory.add(o)};for(o=0;t-1>o;++o)a.forEach(u)},s=function(e){var r={};return e.forEachNode(function(e){var i,a=o(e.slpa.memory,n*t);for(i=0;a.length>i;++i){var u=a[i].name;r.hasOwnProperty(u)?r[u].push(e.id):r[u]=[e.id]}e.communities=a,e.slpa=null,delete e.slpa}),r};return{run:function(){var t=a(e);return u(e,t),s(e)}}},Viva.Graph._community.occuranceMap=function(e){e=e||Viva.random();var t={},n=[],r=!1,i=[],o=function(){var e;i.length=0;for(e in t)t.hasOwnProperty(e)&&i.push(e);i.sort(function(e,n){var r=t[n]-t[e];return r?r:n>e?-1:e>n?1:0})},a=function(){r&&(o(),r=!1)};return{add:function(e){e+="",t.hasOwnProperty(e)?t[e]+=1:t[e]=1,n.push(e),r=!0},getWordCount:function(e){return t[e]||0},getMostPopularFair:function(){if(1===n.length)return n[0];a();var r,o=0;for(r=1;i.length>r&&t[i[r-1]]===t[i[r]];++r)o+=1;return o+=1,i[e.next(o)]},getRandomWord:function(){if(0===n.length)throw"The occurance map is empty. Cannot get empty word";return n[e.next(n.length)]},forEachUniqueWord:function(e){if("function"!=typeof e)throw"Function callback is expected to enumerate all words";var n;for(a(),n=0;i.length>n;++n){var r=i[n],o=t[r],u=e(r,o);if(u)break}}}},Viva.Graph.generator=function(){return{complete:function(e){if(!e||1>e)throw{message:"At least two nodes expected for complete graph"};var t,n,r=Viva.Graph.graph();for(r.Name="Complete K"+e,t=0;e>t;++t)for(n=t+1;e>n;++n)t!==n&&r.addLink(t,n);return r},completeBipartite:function(e,t){if(!e||!t||0>e||0>t)throw{message:"Graph dimensions are invalid. Number of nodes in each partition should be greate than 0"};var n,r,i=Viva.Graph.graph();for(i.Name="Complete K "+e+","+t,n=0;e>n;++n)for(r=e;e+t>r;++r)i.addLink(n,r);return i},ladder:function(e){if(!e||0>e)throw{message:"Invalid number of nodes"};
var t,n=Viva.Graph.graph();for(n.Name="Ladder graph "+e,t=0;e-1>t;++t)n.addLink(t,t+1),n.addLink(e+t,e+t+1),n.addLink(t,e+t);return n.addLink(e-1,2*e-1),n},circularLadder:function(e){if(!e||0>e)throw{message:"Invalid number of nodes"};var t=this.ladder(e);return t.Name="Circular ladder graph "+e,t.addLink(0,e-1),t.addLink(e,2*e-1),t},grid:function(e,t){var n,r,i=Viva.Graph.graph();for(i.Name="Grid graph "+e+"x"+t,n=0;e>n;++n)for(r=0;t>r;++r){var o=n+r*e;n>0&&i.addLink(o,n-1+r*e),r>0&&i.addLink(o,n+(r-1)*e)}return i},path:function(e){if(!e||0>e)throw{message:"Invalid number of nodes"};var t,n=Viva.Graph.graph();for(n.Name="Path graph "+e,n.addNode(0),t=1;e>t;++t)n.addLink(t-1,t);return n},lollipop:function(e,t){if(!t||0>t||!e||0>e)throw{message:"Invalid number of nodes"};var n,r=this.complete(e);for(r.Name="Lollipop graph. Head x Path "+e+"x"+t,n=0;t>n;++n)r.addLink(e+n-1,e+n);return r},balancedBinTree:function(e){var t,n=Viva.Graph.graph(),r=Math.pow(2,e);for(n.Name="Balanced bin tree graph "+e,t=1;r>t;++t){var i=t,o=2*i,a=2*i+1;n.addLink(i,o),n.addLink(i,a)}return n},randomNoLinks:function(e){if(!e||0>e)throw{message:"Invalid number of nodes"};var t,n=Viva.Graph.graph();for(n.Name="Random graph, no Links: "+e,t=0;e>t;++t)n.addNode(t);return n}}},Viva.Graph.View=Viva.Graph.View||{},Viva.Graph.View.cssGraphics=function(){var e,t,n,r="OLD_IE",i=1,o=1,a=function(){var e,t,n=Viva.BrowserInfo.browser;switch(n){case"mozilla":e="Moz";break;case"webkit":e="webkit";break;case"opera":e="O";break;case"msie":if(t=Viva.BrowserInfo.version.split(".")[0],!(t>8))return r;e="ms"}return e?e+"Transform":null}(),u=function(){return a===r?function(e,t,n,r){var i=Math.cos(r),o=Math.sin(r);0>r&&(r=2*Math.PI+r),Math.PI/2>r?(e.style.left=t+"px",e.style.top=n+"px"):Math.PI>r?(e.style.left=t-e.clientWidth*Math.cos(Math.PI-r),e.style.top=n):Math.PI+Math.PI/2>r?(e.style.left=t-e.clientWidth*Math.cos(Math.PI-r),e.style.top=n+e.clientWidth*Math.sin(Math.PI-r)):(e.style.left=t,e.style.top=n+e.clientWidth*Math.sin(Math.PI-r)),e.style.filter='progid:DXImageTransform.Microsoft.Matrix(sizingMethod="auto expand",M11='+i+", M12="+-o+","+"M21="+o+", M22="+i+");"}:a?function(e,t,n,r){e.style.left=t+"px",e.style.top=n+"px",e.style[a]="rotate("+r+"rad)",e.style[a+"Origin"]="left"}:function(){}}(),s=function(){var e=window.document.createElement("div");return e.setAttribute("class","node"),e},f=function(e,t){e.style.left=t.x-5+"px",e.style.top=t.y-5+"px"},c=function(e,t,n){var r=t.x-n.x,i=t.y-n.y,o=Math.sqrt(r*r+i*i);e.style.height="1px",e.style.width=o+"px",u(e,n.x,n.y,Math.atan2(i,r))},d=function(){var e=window.document.createElement("div");return e.setAttribute("class","link"),e},l=function(){if(e){if(!a||a===r)throw"Not implemented. TODO: Implement OLD_IE Filter based transform";var u="matrix("+i+", 0, 0,"+o+","+t+","+n+")";e.style[a]=u}};return{node:function(e){return e&&"function"!=typeof e?s(e):(s=e,this)},link:function(e){return e&&"function"!=typeof e?d(e):(d=e,this)},inputManager:Viva.Input.domInputManager,graphCenterChanged:function(e,r){t=e,n=r,l()},translateRel:function(e,r){t+=e,n+=r,l()},scale:function(){return 1},resetScale:function(){return this},beginRender:function(){},endRender:function(){},placeNode:function(e){return f=e,this},placeLink:function(e){return c=e,this},init:function(t){e=t,l()},initLink:function(t){e.childElementCount>0?e.insertBefore(t,e.firstChild):e.appendChild(t)},releaseLink:function(t){e.removeChild(t)},initNode:function(t){e.appendChild(t)},releaseNode:function(t){e.removeChild(t)},updateNodePosition:function(e,t){f(e,t)},updateLinkPosition:function(e,t,n){c(e,t,n)}}},Viva.Graph.svg=function(e){var t="http://www.w3.org/2000/svg",n="http://www.w3.org/1999/xlink",r=e;return"string"==typeof e&&(r=window.document.createElementNS(t,e)),r.vivagraphAugmented?r:(r.vivagraphAugmented=!0,r.attr=function(e,t){return 2===arguments.length?(null!==t?r.setAttributeNS(null,e,t):r.removeAttributeNS(null,e),r):r.getAttributeNS(null,e)},r.append=function(e){var t=Viva.Graph.svg(e);return r.appendChild(t),t},r.text=function(e){return e!==void 0?(r.textContent=e,r):r.textContent},r.link=function(e){return arguments.length?(r.setAttributeNS(n,"xlink:href",e),r):r.getAttributeNS(n,"xlink:href")},r.children=function(e){var t,n,i=[],o=r.childNodes.length;if(void 0===e&&r.hasChildNodes())for(t=0;o>t;t++)i.push(Viva.Graph.svg(r.childNodes[t]));else if("string"==typeof e){var a="."===e[0],u="#"===e[0],s=!a&&!u;for(t=0;o>t;t++){var f=r.childNodes[t];if(1===f.nodeType){var c=f.attr("class"),d=f.attr("id"),l=f.nodeName;if(a&&c){for(c=c.replace(/\s+/g," ").split(" "),n=0;c.length>n;n++)if(a&&c[n]===e.substr(1)){i.push(Viva.Graph.svg(f));break}}else{if(u&&d===e.substr(1)){i.push(Viva.Graph.svg(f));break}s&&l===e&&i.push(Viva.Graph.svg(f))}i=i.concat(Viva.Graph.svg(f).children(e))}}if(u&&1===i.length)return i[0]}return i},r)},Viva.Graph.View=Viva.Graph.View||{},Viva.Graph.View.svgGraphics=function(){var e,t,n,r,i,o=1,a={},u={},s=function(){return Viva.Graph.svg("rect").attr("width",10).attr("height",10).attr("fill","#00a2e8")},f=function(e,t){e.attr("x",t.x-5).attr("y",t.y-5)},c=function(){return Viva.Graph.svg("line").attr("stroke","#999")},d=function(e,t,n){e.attr("x1",t.x).attr("y1",t.y).attr("x2",n.x).attr("y2",n.y)},l=function(e){e.fire("rescaled")},h={x:0,y:0},v={x:0,y:0},p={x:0,y:0},m=function(){if(e){var t="matrix("+o+", 0, 0,"+o+","+n+","+r+")";e.attr("transform",t)}},g={getNodeUI:function(e){return a[e]},getLinkUI:function(e){return u[e]},node:function(e){return"function"==typeof e?(s=e,this):void 0},link:function(e){return"function"==typeof e?(c=e,this):void 0},placeNode:function(e){return f=e,this},placeLink:function(e){return d=e,this},beginRender:function(){},endRender:function(){},graphCenterChanged:function(e,t){n=e,r=t,m()},inputManager:Viva.Input.domInputManager,translateRel:function(n,r){var i=t.createSVGPoint(),o=e.getCTM(),a=t.createSVGPoint().matrixTransform(o.inverse());i.x=n,i.y=r,i=i.matrixTransform(o.inverse()),i.x=(i.x-a.x)*o.a,i.y=(i.y-a.y)*o.d,o.e+=i.x,o.f+=i.y;var u="matrix("+o.a+", 0, 0,"+o.d+","+o.e+","+o.f+")";e.attr("transform",u)},scale:function(i,a){var u=t.createSVGPoint();u.x=a.x,u.y=a.y,u=u.matrixTransform(e.getCTM().inverse());var s=t.createSVGMatrix().translate(u.x,u.y).scale(i).translate(-u.x,-u.y),f=e.getCTM().multiply(s);o=f.a,n=f.e,r=f.f;var c="matrix("+f.a+", 0, 0,"+f.d+","+f.e+","+f.f+")";return e.attr("transform",c),l(this),o},resetScale:function(){o=1;var t="matrix(1, 0, 0, 1, 0, 0)";return e.attr("transform",t),l(this),this},init:function(n){t=Viva.Graph.svg("svg"),e=Viva.Graph.svg("g").attr("buffered-rendering","dynamic"),t.appendChild(e),n.appendChild(t),m(),"function"==typeof i&&i(t)},release:function(e){t&&e&&e.removeChild(t)},addLink:function(t,n){var r=c(t);if(r)return r.position=n,r.link=t,u[t.id]=r,e.childElementCount>0?e.insertBefore(r,e.firstChild):e.appendChild(r),r},releaseLink:function(t){var n=u[t.id];n&&(e.removeChild(n),delete u[t.id])},addNode:function(t,n){var r=s(t);if(r)return r.position=n,r.node=t,a[t.id]=r,e.appendChild(r),r},releaseNode:function(t){var n=a[t.id];n&&(e.removeChild(n),delete a[t.id])},renderNodes:function(){for(var e in a)if(a.hasOwnProperty(e)){var t=a[e];h.x=t.position.x,h.y=t.position.y,f(t,h,t.node)}},renderLinks:function(){for(var e in u)if(u.hasOwnProperty(e)){var t=u[e];v.x=t.position.from.x,v.y=t.position.from.y,p.x=t.position.to.x,p.y=t.position.to.y,d(t,v,p,t.link)}},getGraphicsRoot:function(e){return"function"==typeof e&&(t?e(t):i=e),t},getSvgRoot:function(){return t}};return Viva.Graph.Utils.events(g).extend(),g},Viva.Graph.View.svgNodeFactory=function(e){var t="#999",n=Viva.Graph.geom(),r=function(e){e.size={w:10,h:10},e.append("rect").attr("width",e.size.w).attr("height",e.size.h).attr("stroke","orange").attr("fill","orange")},i=function(e){return e.size};return{node:function(e){var t=Viva.Graph.svg("g");return r(t,e),t.nodeId=e.id,t},link:function(n){var r=e.getNode(n.fromId),i=r&&r.ui;if(i&&!i.linksContainer){var o=Viva.Graph.svg("path").attr("stroke",t);return i.linksContainer=o,o}return null},customContent:function(e,t){if("function"!=typeof e||"function"!=typeof t)throw"Two functions expected: contentCreator(nodeUI, node) and size(nodeUI)";r=e,i=t},placeNode:function(t,r){var o="",a=i(t);e.forEachLinkedNode(t.nodeId,function(e,u){if(e.position&&e.ui&&e.ui!==t&&u.fromId===t.nodeId){var s=i(e.ui),f=e.position,c=n.intersectRect(r.x-a.w/2,r.y-a.h/2,r.x+a.w/2,r.y+a.h/2,r.x,r.y,f.x,f.y)||r,d=n.intersectRect(f.x-s.w/2,f.y-s.h/2,f.x+s.w/2,f.y+s.h/2,f.x,f.y,r.x,r.y)||f;o+="M"+Math.round(c.x)+" "+Math.round(c.y)+"L"+Math.round(d.x)+" "+Math.round(d.y)}}),t.attr("transform","translate("+(r.x-a.w/2)+", "+(r.y-a.h/2)+")"),""!==o&&t.linksContainer&&t.linksContainer.attr("d",o)}}},Viva.Graph.webgl=function(e){var t=function(t,n){var r=e.createShader(n);if(e.shaderSource(r,t),e.compileShader(r),!e.getShaderParameter(r,e.COMPILE_STATUS)){var i=e.getShaderInfoLog(r);throw window.alert(i),i}return r};return{createProgram:function(n,r){var i=e.createProgram(),o=t(n,e.VERTEX_SHADER),a=t(r,e.FRAGMENT_SHADER);if(e.attachShader(i,o),e.attachShader(i,a),e.linkProgram(i),!e.getProgramParameter(i,e.LINK_STATUS)){var u=e.getShaderInfoLog(i);throw window.alert(u),u}return i},extendArray:function(e,t,n){if((t+1)*n>e.length){var r=new Float32Array(2*e.length*n);return r.set(e),r}return e},copyArrayPart:function(e,t,n,r){var i;for(i=0;r>i;++i)e[t+i]=e[n+i]},swapArrayPart:function(e,t,n,r){var i;for(i=0;r>i;++i){var o=e[t+i];e[t+i]=e[n+i],e[n+i]=o}},getLocations:function(t,n){var r,i={};for(r=0;n.length>r;++r){var o=n[r],a=-1;if(0===o.indexOf("a_")){if(a=e.getAttribLocation(t,o),-1===a)throw"Program doesn't have required attribute: "+o;i[o.slice(2)]=a}else{if(0!==o.indexOf("u_"))throw"Couldn't figure out your intent. All uniforms should start with 'u_' prefix, and attributes with 'a_'";if(a=e.getUniformLocation(t,o),null===a)throw"Program doesn't have required uniform: "+o;i[o.slice(2)]=a}}return i},context:e}},Viva.Graph.View.WebglUtils=function(){},Viva.Graph.View.WebglUtils.prototype.parseColor=function(e){var t=10414335;if("string"==typeof e&&e)if(4===e.length&&(e=e.replace(/([^#])/g,"$1$1")),9===e.length)t=parseInt(e.substr(1),16);else{if(7!==e.length)throw'Color expected in hex format with preceding "#". E.g. #00ff00. Got value: '+e;t=255|parseInt(e.substr(1),16)<<8}else"number"==typeof e&&(t=e);return t},Viva.Graph.View._webglUtil=new Viva.Graph.View.WebglUtils,Viva.Graph.View.webglLine=function(e){return{color:Viva.Graph.View._webglUtil.parseColor(e)}},Viva.Graph.View.webglSquare=function(e,t){return{size:"number"==typeof e?e:10,color:Viva.Graph.View._webglUtil.parseColor(t)}},Viva.Graph.View.webglImage=function(e,t){return{_texture:0,_offset:0,size:"number"==typeof e?e:32,src:t}},Viva.Graph.View.webglNodeProgram=function(){var e,t,n,r,i,o,a,u,s,f=4,c=3*Float32Array.BYTES_PER_ELEMENT+Uint32Array.BYTES_PER_ELEMENT,d=["precision mediump float;","varying vec4 color;","void main(void) {","   gl_FragColor = color;","}"].join("\n"),l=["attribute vec3 a_vertexPos;","attribute vec4 a_color;","uniform vec2 u_screenSize;","uniform mat4 u_transform;","varying vec4 color;","void main(void) {","   gl_Position = u_transform * vec4(a_vertexPos.xy/u_screenSize, 0, 1);","   gl_PointSize = a_vertexPos.z * u_transform[0][0];","   color = a_color.abgr;","}"].join("\n"),h=new ArrayBuffer(16*c),v=new Float32Array(h),p=new Uint32Array(h),m=0,g=function(){if((m+1)*c>=h.byteLength){var e=new ArrayBuffer(2*h.byteLength),t=new Float32Array(e),n=new Uint32Array(e);n.set(p),v=t,p=n,h=e}};return{load:function(o){t=o,i=Viva.Graph.webgl(o),e=i.createProgram(l,d),t.useProgram(e),r=i.getLocations(e,["a_vertexPos","a_color","u_screenSize","u_transform"]),t.enableVertexAttribArray(r.vertexPos),t.enableVertexAttribArray(r.color),n=t.createBuffer()},position:function(e,t){var n=e.id;v[n*f]=t.x,v[n*f+1]=t.y,v[n*f+2]=e.size,p[n*f+3]=e.color},updateTransform:function(e){s=!0,u=e},updateSize:function(e,t){o=e,a=t,s=!0},removeNode:function(e){m>0&&(m-=1),m>e.id&&m>0&&i.copyArrayPart(p,e.id*f,m*f,f)},createNode:function(){g(),m+=1},replaceProperties:function(){},render:function(){t.useProgram(e),t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,h,t.DYNAMIC_DRAW),s&&(s=!1,t.uniformMatrix4fv(r.transform,!1,u),t.uniform2f(r.screenSize,o,a)),t.vertexAttribPointer(r.vertexPos,3,t.FLOAT,!1,f*Float32Array.BYTES_PER_ELEMENT,0),t.vertexAttribPointer(r.color,4,t.UNSIGNED_BYTE,!0,f*Float32Array.BYTES_PER_ELEMENT,12),t.drawArrays(t.POINTS,0,m)}}},Viva.Graph.View.webglLinkProgram=function(){var e,t,n,r,i,o,a,u,s,f,c=6,d=2*(2*Float32Array.BYTES_PER_ELEMENT+Uint32Array.BYTES_PER_ELEMENT),l=["precision mediump float;","varying vec4 color;","void main(void) {","   gl_FragColor = color;","}"].join("\n"),h=["attribute vec2 a_vertexPos;","attribute vec4 a_color;","uniform vec2 u_screenSize;","uniform mat4 u_transform;","varying vec4 color;","void main(void) {","   gl_Position = u_transform * vec4(a_vertexPos/u_screenSize, 0.0, 1.0);","   color = a_color.abgr;","}"].join("\n"),v=0,p=new ArrayBuffer(16*d),m=new Float32Array(p),g=new Uint32Array(p),y=function(){if((v+1)*d>p.byteLength){var e=new ArrayBuffer(2*p.byteLength),t=new Float32Array(e),n=new Uint32Array(e);n.set(g),m=t,g=n,p=e}};return{load:function(o){t=o,r=Viva.Graph.webgl(o),e=r.createProgram(h,l),t.useProgram(e),i=r.getLocations(e,["a_vertexPos","a_color","u_screenSize","u_transform"]),t.enableVertexAttribArray(i.vertexPos),t.enableVertexAttribArray(i.color),n=t.createBuffer()},position:function(e,t,n){var r=e.id,i=r*c;m[i]=t.x,m[i+1]=t.y,g[i+2]=e.color,m[i+3]=n.x,m[i+4]=n.y,g[i+5]=e.color},createLink:function(e){y(),v+=1,o=e.id},removeLink:function(e){v>0&&(v-=1),v>e.id&&v>0&&r.copyArrayPart(g,e.id*c,v*c,c)},updateTransform:function(e){f=!0,s=e},updateSize:function(e,t){a=e,u=t,f=!0},render:function(){t.useProgram(e),t.bindBuffer(t.ARRAY_BUFFER,n),t.bufferData(t.ARRAY_BUFFER,p,t.DYNAMIC_DRAW),f&&(f=!1,t.uniformMatrix4fv(i.transform,!1,s),t.uniform2f(i.screenSize,a,u)),t.vertexAttribPointer(i.vertexPos,2,t.FLOAT,!1,3*Float32Array.BYTES_PER_ELEMENT,0),t.vertexAttribPointer(i.color,4,t.UNSIGNED_BYTE,!0,3*Float32Array.BYTES_PER_ELEMENT,8),t.drawArrays(t.LINES,0,2*v),o=v-1},bringToFront:function(e){o>e.id&&r.swapArrayPart(m,e.id*c,o*c,c),o>0&&(o-=1)},getFrontLinkId:function(){return o}}},Viva.Graph.View.Texture=function(e){this.canvas=window.document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.isDirty=!1,this.canvas.width=this.canvas.height=e},Viva.Graph.View.webglAtlas=function(e){var t,n,r=Math.sqrt(e||1024)<<0,i=r,o=1,a={},u=0,s=[],f=[],c=function(e){return 0===(e&e-1)},d=function(){var e=new Viva.Graph.View.Texture(r*i);s.push(e)},l=function(t){var n=t/e<<0,i=t%e,o=i/r<<0,a=i%r;return{textureNumber:n,row:o,col:a}},h=function(){n.isDirty=!0,u=0,t=null},v=function(){t&&(window.clearTimeout(t),u+=1,t=null),u>10?h():t=window.setTimeout(h,400)},p=function(e,t){var n=s[e.textureNumber].canvas,r=s[t.textureNumber].ctx,o=t.col*i,a=t.row*i;r.drawImage(n,e.col*i,e.row*i,i,i,o,a,i,i),s[e.textureNumber].isDirty=!0,s[t.textureNumber].isDirty=!0},m=function(e,t,n){var r=l(e),o={offset:e};r.textureNumber>=s.length&&d();var u=s[r.textureNumber];u.ctx.drawImage(t,r.col*i,r.row*i,i,i),f[e]=t.src,a[t.src]=o,u.isDirty=!0,n(o)};if(!c(e))throw"Tiles per texture should be power of two.";return n={isDirty:!1,clearDirty:function(){var e;for(this.isDirty=!1,e=0;s.length>e;++e)s[e].isDirty=!1},remove:function(e){var t=a[e];if(!t)return!1;if(delete a[e],o-=1,o===t.offset)return!0;var n=l(t.offset),r=l(o);p(r,n);var i=a[f[o]];return i.offset=t.offset,f[t.offset]=f[o],v(),!0},getTextures:function(){return s},getCoordinates:function(e){return a[e]},load:function(e,t){if(a.hasOwnProperty(e))t(a[e]);else{var n=new window.Image,r=o;o+=1,n.crossOrigin="anonymous",n.onload=function(){v(),m(r,n,t)},n.src=e}}}},Viva.Graph.View.webglImageNodeProgram=function(){var e,t,n,r,i,o,a,u,s,f,c=18,d=["precision mediump float;","varying vec4 color;","varying vec3 vTextureCoord;","uniform sampler2D u_sampler0;","uniform sampler2D u_sampler1;","uniform sampler2D u_sampler2;","uniform sampler2D u_sampler3;","void main(void) {","   if (vTextureCoord.z == 0.) {","     gl_FragColor = texture2D(u_sampler0, vTextureCoord.xy);","   } else if (vTextureCoord.z == 1.) {","     gl_FragColor = texture2D(u_sampler1, vTextureCoord.xy);","   } else if (vTextureCoord.z == 2.) {","     gl_FragColor = texture2D(u_sampler2, vTextureCoord.xy);","   } else if (vTextureCoord.z == 3.) {","     gl_FragColor = texture2D(u_sampler3, vTextureCoord.xy);","   } else { gl_FragColor = vec4(0, 1, 0, 1); }","}"].join("\n"),l=["attribute vec2 a_vertexPos;","attribute float a_customAttributes;","uniform vec2 u_screenSize;","uniform mat4 u_transform;","uniform float u_tilesPerTexture;","varying vec3 vTextureCoord;","void main(void) {","   gl_Position = u_transform * vec4(a_vertexPos/u_screenSize, 0, 1);","float corner = mod(a_customAttributes, 4.);","float tileIndex = mod(floor(a_customAttributes / 4.), u_tilesPerTexture);","float tilesPerRow = sqrt(u_tilesPerTexture);","float tileSize = 1./tilesPerRow;","float tileColumn = mod(tileIndex, tilesPerRow);","float tileRow = floor(tileIndex/tilesPerRow);","if(corner == 0.0) {","  vTextureCoord.xy = vec2(0, 1);","} else if(corner == 1.0) {","  vTextureCoord.xy = vec2(1, 1);","} else if(corner == 2.0) {","  vTextureCoord.xy = vec2(0, 0);","} else {","  vTextureCoord.xy = vec2(1, 0);","}","vTextureCoord *= tileSize;","vTextureCoord.x += tileColumn * tileSize;","vTextureCoord.y += tileRow * tileSize;","vTextureCoord.z = floor(floor(a_customAttributes / 4.)/u_tilesPerTexture);","}"].join("\n"),h=1024,v=0,p=new Float32Array(64),m=function(e,t){e.nativeObject&&n.deleteTexture(e.nativeObject);var r=n.createTexture();n.activeTexture(n["TEXTURE"+t]),n.bindTexture(n.TEXTURE_2D,r),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,n.RGBA,n.UNSIGNED_BYTE,e.canvas),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR_MIPMAP_NEAREST),n.generateMipmap(n.TEXTURE_2D),n.uniform1i(o["sampler"+t],t),e.nativeObject=r},g=function(){if(e.isDirty){var t,n=e.getTextures();for(t=0;n.length>t;++t)(n[t].isDirty||!n[t].nativeObject)&&m(n[t],t);e.clearDirty()}};return{load:function(a){n=a,i=Viva.Graph.webgl(a),e=new Viva.Graph.View.webglAtlas(h),t=i.createProgram(l,d),n.useProgram(t),o=i.getLocations(t,["a_vertexPos","a_customAttributes","u_screenSize","u_transform","u_sampler0","u_sampler1","u_sampler2","u_sampler3","u_tilesPerTexture"]),n.uniform1f(o.tilesPerTexture,h),n.enableVertexAttribArray(o.vertexPos),n.enableVertexAttribArray(o.customAttributes),r=n.createBuffer()},position:function(e,t){var n=e.id*c;p[n]=t.x-e.size,p[n+1]=t.y-e.size,p[n+2]=4*e._offset,p[n+3]=t.x+e.size,p[n+4]=t.y-e.size,p[n+5]=4*e._offset+1,p[n+6]=t.x-e.size,p[n+7]=t.y+e.size,p[n+8]=4*e._offset+2,p[n+9]=t.x-e.size,p[n+10]=t.y+e.size,p[n+11]=4*e._offset+2,p[n+12]=t.x+e.size,p[n+13]=t.y-e.size,p[n+14]=4*e._offset+1,p[n+15]=t.x+e.size,p[n+16]=t.y+e.size,p[n+17]=4*e._offset+3},createNode:function(t){p=i.extendArray(p,v,c),v+=1;var n=e.getCoordinates(t.src);n?t._offset=n.offset:(t._offset=0,e.load(t.src,function(e){t._offset=e.offset}))},removeNode:function(t){v>0&&(v-=1),v>t.id&&v>0&&(t.src&&e.remove(t.src),i.copyArrayPart(p,t.id*c,v*c,c))},replaceProperties:function(e,t){t._offset=e._offset},updateTransform:function(e){f=!0,s=e},updateSize:function(e,t){a=e,u=t,f=!0},render:function(){n.useProgram(t),n.bindBuffer(n.ARRAY_BUFFER,r),n.bufferData(n.ARRAY_BUFFER,p,n.DYNAMIC_DRAW),f&&(f=!1,n.uniformMatrix4fv(o.transform,!1,s),n.uniform2f(o.screenSize,a,u)),n.vertexAttribPointer(o.vertexPos,2,n.FLOAT,!1,3*Float32Array.BYTES_PER_ELEMENT,0),n.vertexAttribPointer(o.customAttributes,1,n.FLOAT,!1,3*Float32Array.BYTES_PER_ELEMENT,8),g(),n.drawArrays(n.TRIANGLES,0,6*v)}}},Viva.Graph.View=Viva.Graph.View||{},Viva.Graph.View.webglGraphics=function(e){e=Viva.lazyExtend(e,{enableBlending:!0,preserveDrawingBuffer:!1,clearColor:!1,clearColorValue:{r:1,g:1,b:1,a:1}});var t,n,r,i,o,a,u,s,f=0,c=0,d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],l=[],h=[],v={},p={},m=Viva.Graph.View.webglLinkProgram(),g=Viva.Graph.View.webglNodeProgram(),y=function(){return Viva.Graph.View.webglSquare()},x=function(){return Viva.Graph.View.webglLine(3014898687)},w=function(){m.updateTransform(d),g.updateTransform(d)},V=function(){d=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},b=function(){t&&n&&(i=n.width=Math.max(t.offsetWidth,1),o=n.height=Math.max(t.offsetHeight,1),r&&r.viewport(0,0,i,o),m&&m.updateSize(i/2,o/2),g&&g.updateSize(i/2,o/2))},N=function(e){e.fire("rescaled")},P={getLinkUI:function(e){return p[e]},getNodeUI:function(e){return v[e]},node:function(e){return"function"==typeof e?(y=e,this):void 0},link:function(e){return"function"==typeof e?(x=e,this):void 0},placeNode:function(e){return a=e,this},placeLink:function(e){return u=e,this},inputManager:Viva.Input.webglInputManager,beginRender:function(){},endRender:function(){c>0&&m.render(),f>0&&g.render()},bringLinkToFront:function(e){var t,n,r=m.getFrontLinkId();m.bringToFront(e),r>e.id&&(t=e.id,n=h[r],h[r]=h[t],h[r].id=r,h[t]=n,h[t].id=t)},graphCenterChanged:function(e,t){d[12]=2*e/i-1,d[13]=1-2*t/o,w()},addLink:function(e,t){var n=c++,r=x(e);return r.id=n,r.pos=t,m.createLink(r),h[n]=r,p[e.id]=r,r},addNode:function(e,t){var n=f++,r=y(e);return r.id=n,r.position=t,r.node=e,g.createNode(r),l[n]=r,v[e.id]=r,r},translateRel:function(e,t){d[12]+=2*d[0]*e/i/d[0],d[13]-=2*d[5]*t/o/d[5],w()},scale:function(e,t){var n=2*t.x/i-1,r=1-2*t.y/o;return n-=d[12],r-=d[13],d[12]+=n*(1-e),d[13]+=r*(1-e),d[0]*=e,d[5]*=e,w(),N(this),d[0]},resetScale:function(){return V(),r&&(b(),w()),this},init:function(a){var u={};if(e.preserveDrawingBuffer&&(u.preserveDrawingBuffer=!0),t=a,n=window.document.createElement("canvas"),b(),V(),t.appendChild(n),r=n.getContext("experimental-webgl",u),!r){var f="Could not initialize WebGL. Seems like the browser doesn't support it.";throw window.alert(f),f}if(e.enableBlending&&(r.blendFunc(r.SRC_ALPHA,r.ONE_MINUS_SRC_ALPHA),r.enable(r.BLEND)),e.clearColor){var c=e.clearColorValue;r.clearColor(c.r,c.g,c.b,c.a),this.beginRender=function(){r.clear(r.COLOR_BUFFER_BIT)}}m.load(r),m.updateSize(i/2,o/2),g.load(r),g.updateSize(i/2,o/2),w(),"function"==typeof s&&s(n)},release:function(e){n&&e&&e.removeChild(n)},isSupported:function(){var e=window.document.createElement("canvas"),t=e&&e.getContext&&e.getContext("experimental-webgl");return t},releaseLink:function(e){c>0&&(c-=1);var t=p[e.id];delete p[e.id],m.removeLink(t);var n=t.id;if(c>n){if(0===c||c===n)return;var r=h[c];h[n]=r,r.id=n}},releaseNode:function(e){f>0&&(f-=1);var t=v[e.id];delete v[e.id],g.removeNode(t);var n=t.id;if(f>n){if(0===f||f===n)return;var r=l[f];l[n]=r,r.id=n,g.replaceProperties(t,r)}},renderNodes:function(){for(var e={x:0,y:0},t=0;f>t;++t){var n=l[t];e.x=n.position.x,e.y=-n.position.y,a&&a(n,e),g.position(n,e)}},renderLinks:function(){if(!this.omitLinksRendering)for(var e={x:0,y:0},t={x:0,y:0},n=0;c>n;++n){var r=h[n],i=r.pos.from;t.x=i.x,t.y=-i.y,i=r.pos.to,e.x=i.x,e.y=-i.y,u&&u(r,t,e),m.position(r,t,e)}},getGraphicsRoot:function(e){return"function"==typeof e&&(n?e(n):s=e),n},setNodeProgram:function(e){if(!r&&e)g=e;else if(e)throw"Not implemented. Cannot swap shader on the fly... yet."},setLinkProgram:function(e){if(!r&&e)m=e;else if(e)throw"Not implemented. Cannot swap shader on the fly... yet."},transformClientToGraphCoordinates:function(e){return e.x=2*e.x/i-1,e.y=1-2*e.y/o,e.x=(e.x-d[12])/d[0],e.y=(e.y-d[13])/d[5],e.x*=i/2,e.y*=-o/2,e},getNodeAtClientPos:function(e,t){if("function"!=typeof t)return null;this.transformClientToGraphCoordinates(e);for(var n=0;f>n;++n)if(t(l[n],e.x,e.y))return l[n].node;return null}};return Viva.Graph.Utils.events(P).extend(),P},Viva.Graph.webglInputEvents=function(e){if(e.webglInputEvents)return e.webglInputEvents;var t,n,r=function(e,t,n){if(e&&e.size){var r=e.position,i=e.size;return t>r.x-i&&r.x+i>t&&n>r.y-i&&r.y+i>n}return!0},i=function(t){return e.getNodeAtClientPos(t,r)},o=null,a=[],u=[],s=[],f=[],c=[],d=[],l=[],h=Viva.Graph.Utils.events(window.document),v=function(e){e.stopPropagation?e.stopPropagation():e.cancelBubble=!0},p=function(e){return v(e),!1},m=function(e,t){var n,r;for(n=0;e.length>n;n+=1)if(r=e[n].apply(void 0,t))return!0},g=function(e){var r={x:0,y:0},g=null,y=+new Date,x=function(e){m(c,[g,e]),r.x=e.clientX,r.y=e.clientY},w=function(){h.stop("mousemove",x),h.stop("mouseup",w)},V=function(){n=e.getBoundingClientRect()};window.addEventListener("resize",V),V(),e.addEventListener("mousemove",function(e){if(!o){var t,s=!1;r.x=e.clientX-n.left,r.y=e.clientY-n.top,t=i(r),t&&g!==t?(g=t,s=s||m(a,[g])):null===t&&g!==t&&(s=s||m(u,[g]),g=null),s&&v(e)}}),e.addEventListener("mousedown",function(e){var o,a=!1;r.x=e.clientX-n.left,r.y=e.clientY-n.top,o=[i(r),e],o[0]?(a=m(s,o),h.on("mousemove",x),h.on("mouseup",w),t=window.document.onselectstart,window.document.onselectstart=p,g=o[0]):g=null,a&&v(e)}),e.addEventListener("mouseup",function(e){var o,a=+new Date;r.x=e.clientX-n.left,r.y=e.clientY-n.top,o=[i(r),e],o[0]&&(window.document.onselectstart=t,400>a-y&&o[0]===g?m(l,o):m(d,o),y=a,m(f,o)&&v(e))})};return e.getGraphicsRoot(g),e.webglInputEvents={mouseEnter:function(e){return"function"==typeof e&&a.push(e),this},mouseLeave:function(e){return"function"==typeof e&&u.push(e),this},mouseDown:function(e){return"function"==typeof e&&s.push(e),this},mouseUp:function(e){return"function"==typeof e&&f.push(e),this},mouseMove:function(e){return"function"==typeof e&&c.push(e),this},click:function(e){return"function"==typeof e&&d.push(e),this},dblClick:function(e){return"function"==typeof e&&l.push(e),this},mouseCapture:function(e){o=e},releaseMouseCapture:function(){o=null}},e.webglInputEvents},Viva.Input=Viva.Input||{},Viva.Input.webglInputManager=function(e,t){var n=Viva.Graph.webglInputEvents(t),r=null,i={},o={x:0,y:0};return n.mouseDown(function(e,t){r=e,o.x=t.clientX,o.y=t.clientY,n.mouseCapture(r);var a=i[e.id];return a&&a.onStart&&a.onStart(t,o),!0}).mouseUp(function(e){n.releaseMouseCapture(r),r=null;var t=i[e.id];return t&&t.onStop&&t.onStop(),!0}).mouseMove(function(e,t){if(r){var n=i[r.id];return n&&n.onDrag&&n.onDrag(t,{x:t.clientX-o.x,y:t.clientY-o.y}),o.x=t.clientX,o.y=t.clientY,!0}}),{bindDragNDrop:function(e,t){i[e.id]=t,t||delete i[e.id]}}};