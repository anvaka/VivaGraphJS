var Viva=Viva||{};Viva.Graph=Viva.Graph||{},"undefined"!=typeof module&&module.exports&&(module.exports=Viva),Viva.Graph.version="0.5.72",Viva.lazyExtend=function(a,b){var c;if(a||(a={}),b)for(c in b)if(b.hasOwnProperty(c)){var d=a.hasOwnProperty(c),e=typeof b[c],f=!d||typeof a[c]!==e;f?a[c]=b[c]:"object"===e&&(a[c]=Viva.lazyExtend(a[c],b[c]))}return a},Viva.random=function(){var a,b=arguments[0];a="number"==typeof b?b:"string"==typeof b?b.length:+new Date;var c=function(){return a=a+2127912214+(a<<12)&4294967295,a=4294967295&(3345072700^a^a>>>19),a=a+374761393+(a<<5)&4294967295,a=4294967295&(a+3550635116^a<<9),a=a+4251993797+(a<<3)&4294967295,a=4294967295&(3042594569^a^a>>>16),(268435455&a)/268435456};return{next:function(a){return Math.floor(c()*a)},nextDouble:function(){return c()}}},Viva.randomIterator=function(a,b){return b=b||Viva.random(),{forEach:function(c){var d,e,f;for(d=a.length-1;d>0;--d)e=b.next(d+1),f=a[e],a[e]=a[d],a[d]=f,c(f);a.length&&c(a[0])},shuffle:function(){var c,d,e;for(c=a.length-1;c>0;--c)d=b.next(c+1),e=a[d],a[d]=a[c],a[c]=e;return a}}},Viva.BrowserInfo=function(){if("undefined"==typeof window||!window.hasOwnProperty("navigator"))return{browser:"",version:"0"};var a=window.navigator.userAgent.toLowerCase(),b=/(webkit)[ \/]([\w.]+)/,c=/(opera)(?:.*version)?[ \/]([\w.]+)/,d=/(msie) ([\w.]+)/,e=/(mozilla)(?:.*? rv:([\w.]+))?/,f=b.exec(a)||c.exec(a)||d.exec(a)||a.indexOf("compatible")<0&&e.exec(a)||[];return{browser:f[1]||"",version:f[2]||"0"}}(),Viva.Graph.Utils=Viva.Graph.Utils||{},Viva.Graph.Utils.indexOfElementInArray=function(a,b){if(b.indexOf)return b.indexOf(a);var c,d=b.length;for(c=0;d>c;c+=1)if(b.hasOwnProperty(c)&&b[c]===a)return c;return-1},Viva.Graph.Utils=Viva.Graph.Utils||{},Viva.Graph.Utils.getDimension=function(a){if(!a)throw{message:"Cannot get dimensions of undefined container"};var b=a.clientWidth,c=a.clientHeight;return{left:0,top:0,width:b,height:c}},Viva.Graph.Utils.findElementPosition=function(a){var b=0,c=0;if(a.offsetParent)do b+=a.offsetLeft,c+=a.offsetTop;while(null!==(a=a.offsetParent));return[b,c]},Viva.Graph.Utils=Viva.Graph.Utils||{},Viva.Graph.Utils.events=function(a){var b=function(a){var b={};return a.fire=function(a,c){var d,e,f,g;if("string"!=typeof a)throw"Only strings can be used as even type";if(b.hasOwnProperty(a))for(d=b[a],g=0;g<d.length;++g)f=d[g],(e=f.method)(c);return this},a.addEventListener=function(a,c){if("function"!=typeof c)throw"Only functions allowed to be callbacks";var d={method:c};return b.hasOwnProperty(a)?b[a].push(d):b[a]=[d],this},a.removeEventListener=function(a,c){if("function"!=typeof c)throw"Only functions allowed to be callbacks";if(b.hasOwnProperty(a)){var d,e=b[a];for(d=0;d<e.length;++d)if(e[d].callback===c){e.splice(d);break}}return this},a.removeAllListeners=function(){var a;for(a in b)b.hasOwnProperty(a)&&delete b[a]},a};return{on:function(b,c){return a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c),this},stop:function(b,c){a.removeEventListener?a.removeEventListener(b,c,!1):a.detachEvent&&a.detachEvent("on"+b,c)},extend:function(){return b(a)}}},Viva.Graph.Utils=Viva.Graph.Utils||{},Viva.Graph.Utils.dragndrop=function(a){var b,c,d,e,f,g,h,i=Viva.Graph.Utils.events(window.document),j=Viva.Graph.Utils.events(a),k=Viva.Graph.Utils.findElementPosition,l=0,m=0,n=!1,o=0,p=function(a){var b=0,c=0;return a=a||window.event,a.pageX||a.pageY?(b=a.pageX,c=a.pageY):(a.clientX||a.clientY)&&(b=a.clientX+window.document.body.scrollLeft+window.document.documentElement.scrollLeft,c=a.clientY+window.document.body.scrollTop+window.document.documentElement.scrollTop),[b,c]},q=function(a,b,d){c&&c(a,{x:b-l,y:d-m}),l=b,m=d},r=function(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0},s=function(a){a.preventDefault&&a.preventDefault()},t=function(a){return r(a),!1},u=function(a){a=a||window.event,q(a,a.clientX,a.clientY)},v=function(a){if(a=a||window.event,n)return r(a),!1;var c=1===a.button&&null!==window.event||0===a.button;return c?(l=a.clientX,m=a.clientY,h=a.target||a.srcElement,b&&b(a,{x:l,y:m}),i.on("mousemove",u),i.on("mouseup",w),r(a),f=window.document.onselectstart,g=window.document.ondragstart,window.document.onselectstart=t,h.ondragstart=t,!1):void 0},w=function(a){a=a||window.event,i.stop("mousemove",u),i.stop("mouseup",w),window.document.onselectstart=f,h.ondragstart=g,h=null,d&&d(a)},x=function(b){if("function"==typeof e){b=b||window.event,b.preventDefault&&b.preventDefault(),b.returnValue=!1;var c,d=p(b),f=k(a),g={x:d[0]-f[0],y:d[1]-f[1]};c=b.wheelDelta?b.wheelDelta/360:b.detail/-9,e(b,c,g)}},y=function(b){!e&&b?"webkit"===Viva.BrowserInfo.browser?a.addEventListener("mousewheel",x,!1):a.addEventListener("DOMMouseScroll",x,!1):e&&!b&&("webkit"===Viva.BrowserInfo.browser?a.removeEventListener("mousewheel",x,!1):a.removeEventListener("DOMMouseScroll",x,!1)),e=b},z=function(a,b){return(a.clientX-b.clientX)*(a.clientX-b.clientX)+(a.clientY-b.clientY)*(a.clientY-b.clientY)},A=function(a){if(1===a.touches.length){r(a);var b=a.touches[0];q(a,b.clientX,b.clientY)}else if(2===a.touches.length){var c=z(a.touches[0],a.touches[1]),d=0;o>c?d=-1:c>o&&(d=1),e(a,d,{x:a.touches[0].clientX,y:a.touches[0].clientY}),o=c,r(a),s(a)}},B=function(a){n=!1,i.stop("touchmove",A),i.stop("touchend",B),i.stop("touchcancel",B),h=null,d&&d(a)},C=function(a,c){r(a),s(a),l=c.clientX,m=c.clientY,h=a.target||a.srcElement,b&&b(a,{x:l,y:m}),n||(n=!0,i.on("touchmove",A),i.on("touchend",B),i.on("touchcancel",B))},D=function(b){return console.log("Touch start for ",a),1===b.touches.length?C(b,b.touches[0]):void(2===b.touches.length&&(r(b),s(b),o=z(b.touches[0],b.touches[1])))};return j.on("mousedown",v),j.on("touchstart",D),{onStart:function(a){return b=a,this},onDrag:function(a){return c=a,this},onStop:function(a){return d=a,this},onScroll:function(a){return y(a),this},release:function(){i.stop("mousemove",u),i.stop("mousedown",v),i.stop("mouseup",w),i.stop("touchmove",A),i.stop("touchend",B),i.stop("touchcancel",B),y(null)}}},Viva.Input=Viva.Input||{},Viva.Input.domInputManager=function(a,b){var c={};return{bindDragNDrop:function(a,d){var e;if(d){var f=b.getNodeUI(a.id);e=Viva.Graph.Utils.dragndrop(f),"function"==typeof d.onStart&&e.onStart(d.onStart),"function"==typeof d.onDrag&&e.onDrag(d.onDrag),"function"==typeof d.onStop&&e.onStop(d.onStop),c[a.id]=e}else(e=c[a.id])&&(e.release(),delete c[a.id])}}},Viva.Graph.Utils=Viva.Graph.Utils||{},function(){var a,b,c=0,d=["ms","moz","webkit","o"];for(b="undefined"!=typeof window?window:"undefined"!=typeof global?global:{setTimeout:function(){},clearTimeout:function(){}},a=0;a<d.length&&!b.requestAnimationFrame;++a){var e=d[a];b.requestAnimationFrame=b[e+"RequestAnimationFrame"],b.cancelAnimationFrame=b[e+"CancelAnimationFrame"]||b[e+"CancelRequestAnimationFrame"]}b.requestAnimationFrame||(b.requestAnimationFrame=function(a){var d=(new Date).getTime(),e=Math.max(0,16-(d-c)),f=b.setTimeout(function(){a(d+e)},e);return c=d+e,f}),b.cancelAnimationFrame||(b.cancelAnimationFrame=function(a){b.clearTimeout(a)}),Viva.Graph.Utils.timer=function(a){var c,d=function(){b.cancelAnimationFrame(c),c=0},e=function(){c=b.requestAnimationFrame(e),a()||d()};return e(),{stop:d,restart:function(){c||e()}}}}(),Viva.Graph.geom=function(){return{intersect:function(a,b,c,d,e,f,g,h){var i,j,k,l,m,n,o,p,q,r,s,t,u,v={x:0,y:0};return i=d-b,k=a-c,m=c*b-a*d,q=i*e+k*f+m,r=i*g+k*h+m,0!==q&&0!==r&&q>=0==r>=4?null:(j=h-f,l=e-g,n=g*f-e*h,o=j*a+l*b+n,p=j*c+l*d+n,0!==o&&0!==p&&o>=0==p>=0?null:(s=i*l-j*k,0===s?null:(t=0>s?-s/2:s/2,t=0,u=k*n-l*m,v.x=(0>u?u-t:u+t)/s,u=j*m-i*n,v.y=(0>u?u-t:u+t)/s,v)))},intersectRect:function(a,b,c,d,e,f,g,h){return this.intersect(a,b,a,d,e,f,g,h)||this.intersect(a,d,c,d,e,f,g,h)||this.intersect(c,d,c,b,e,f,g,h)||this.intersect(c,b,a,b,e,f,g,h)},convexHull:function(a){var b=function(a,b){var c,d,e=function(b){var c=b.x-a.x,d=b.y-a.y,e=c>0?1:-1;return e*c*c/(c*c+d*d)},f=b.sort(function(a,b){return e(b)-e(a)}),g=f[0],h=e(g),i=g.x-a.x,j=g.y-a.y,k=i*i+j*j;for(d=1;d<f.length;++d){g=f[d];var l=e(g);l===h?(i=g.x-a.x,j=g.y-a.y,c=i*i+j*j,k>c?f.splice(d,1):f.splice(d-1,1)):h=l}return f},c=function(a,b,c){return(c.x-a.x)*(b.y-a.y)-(c.y-a.y)*(b.x-a.x)<0};if(a.length<3)return a;var d,e=0;for(d=0;d<a.length;++d)a[d].y<a[e].y?e=d:a[d].y===a[e].y&&a[d].x<a[e].x&&(e=d);var f=a[e];a.splice(e,1);var g=b(f,a);if(g.length<2)return g;var h=[];h.push(f),h.push(g[0]),h.push(g[1]);var i=h.length;for(d=2;d<g.length;++d){for(;!c(h[i-2],h[i-1],g[d]);)h.pop(),i-=1;h.push(g[d]),i+=1}return h}}},Viva.Graph.Rect=function(a,b,c,d){this.x1=a||0,this.y1=b||0,this.x2=c||0,this.y2=d||0},Viva.Graph.Point2d=function(a,b){this.x=a||0,this.y=b||0},Viva.Graph.Node=function(a){this.id=a,this.links=[],this.data=null},Viva.Graph.Link=function(a,b,c,d){this.fromId=a,this.toId=b,this.data=c,this.id=d},Viva.Graph.graph=function(){var a="function"==typeof Object.create?Object.create(null):{},b=[],c={},d=0,e=0,f=[],g=function(a){a.fire("changed",f)},h=function(){e+=1},i=function(a){e-=1,0===e&&f.length>0&&(g(a),f.length=0)},j=function(a,b){f.push({node:a,changeType:b})},k=function(a,b){f.push({link:a,changeType:b})},l={addNode:function(b,c){if("undefined"==typeof b)throw{message:"Invalid node identifier"};h();var e=this.getNode(b);return e?j(e,"update"):(e=new Viva.Graph.Node(b),d++,j(e,"add")),e.data=c,a[b]=e,i(this),e},addLink:function(a,d,e){h();var f=this.getNode(a)||this.addNode(a),g=this.getNode(d)||this.addNode(d),j=a.toString()+"ðŸ‘‰ "+d.toString(),l=c.hasOwnProperty(j);(l||this.hasLink(a,d))&&(l||(c[j]=0),j+="@"+ ++c[j]);var m=new Viva.Graph.Link(a,d,e,j);return b.push(m),f.links.push(m),g.links.push(m),k(m,"add"),i(this),m},removeLink:function(a){if(!a)return!1;var c=Viva.Graph.Utils.indexOfElementInArray(a,b);if(0>c)return!1;h(),b.splice(c,1);var d=this.getNode(a.fromId),e=this.getNode(a.toId);return d&&(c=Viva.Graph.Utils.indexOfElementInArray(a,d.links),c>=0&&d.links.splice(c,1)),e&&(c=Viva.Graph.Utils.indexOfElementInArray(a,e.links),c>=0&&e.links.splice(c,1)),k(a,"remove"),i(this),!0},removeNode:function(b){var c=this.getNode(b);if(!c)return!1;for(h();c.links.length;){var e=c.links[0];this.removeLink(e)}a[b]=null,delete a[b],d--,j(c,"remove"),i(this)},getNode:function(b){return a[b]},getNodesCount:function(){return d},getLinksCount:function(){return b.length},getLinks:function(a){var b=this.getNode(a);return b?b.links:null},forEachNode:function(b){if("function"==typeof b){var c;for(c in a)if(b(a[c]))return}},forEachLinkedNode:function(b,c,d){var e,f,g,h=this.getNode(b);if(h&&h.links&&"function"==typeof c)if(d)for(e=0;e<h.links.length;++e)f=h.links[e],f.fromId===b&&c(a[f.toId],f);else for(e=0;e<h.links.length;++e)f=h.links[e],g=f.fromId===b?f.toId:f.fromId,c(a[g],f)},forEachUnlinkedNode:function(b,c,d){var e,f=this,g=f.getNode(b);if(g&&"function"==typeof c){var h={};f.forEachLinkedNode(b,function(a){h[a.id]=!0},d);for(e in a)h.hasOwnProperty(e)||c(a[e])}},forEachLink:function(a){var c,d;if("function"==typeof a)for(c=0,d=b.length;d>c;++c)a(b[c])},beginUpdate:function(){h()},endUpdate:function(){i(this)},clear:function(){var a=this;a.beginUpdate(),a.forEachNode(function(b){a.removeNode(b.id)}),a.endUpdate()},hasLink:function(a,b){var c,d=this.getNode(a);if(!d)return null;for(c=0;c<d.links.length;++c){var e=d.links[c];if(e.fromId===a&&e.toId===b)return e}return null}};return Viva.Graph.Utils.events(l).extend(),l},Viva.Graph.operations=function(){return{density:function(a,b){var c=a.getNodesCount();return 0===c?0/0:b?a.getLinksCount()/(c*(c-1)):2*a.getLinksCount()/(c*(c-1))}}},Viva.Graph.Physics=Viva.Graph.Physics||{},Viva.Graph.Physics.Vector=function(a,b){this.x=a||0,this.y=b||0},Viva.Graph.Physics.Vector.prototype={multiply:function(a){return new Viva.Graph.Physics.Vector(this.x*a,this.y*a)}},Viva.Graph.Physics.Point=function(a,b){this.x=a||0,this.y=b||0},Viva.Graph.Physics.Point.prototype={add:function(a){return new Viva.Graph.Physics.Point(this.x+a.x,this.y+a.y)}},Viva.Graph.Physics.Body=function(){this.mass=1,this.force=new Viva.Graph.Physics.Vector,this.velocity=new Viva.Graph.Physics.Vector,this.location=new Viva.Graph.Physics.Point,this.prevLocation=new Viva.Graph.Physics.Point},Viva.Graph.Physics.Body.prototype={loc:function(a){return a?(this.location.x=a.x,this.location.y=a.y,this):this.location},vel:function(a){return a?(this.velocity.x=a.x,this.velocity.y=a.y,this):this.velocity}},Viva.Graph.Physics.Spring=function(a,b,c,d,e){this.body1=a,this.body2=b,this.length=c,this.coeff=d,this.weight=e},Viva.Graph.Physics.QuadTreeNode=function(){this.centerOfMass=new Viva.Graph.Physics.Point,this.children=[],this.body=null,this.hasChildren=!1,this.x1=0,this.y1=0,this.x2=0,this.y2=0},Viva.Graph.Physics=Viva.Graph.Physics||{},Viva.Graph.Physics.eulerIntegrator=function(){return{integrate:function(a,b){var c,d=a.speedLimit,e=0,f=0,g=0,h=0,i=a.bodies.length;for(c=0;i>c;++c){var j=a.bodies[c],k=b/j.mass;j.velocity.x+=k*j.force.x,j.velocity.y+=k*j.force.y;var l=j.velocity.x,m=j.velocity.y,n=Math.sqrt(l*l+m*m);n>d&&(j.velocity.x=d*l/n,j.velocity.y=d*m/n),f=b*j.velocity.x,h=b*j.velocity.y,j.location.x+=f,j.location.y+=h,e+=f,g+=h}return(e*e+g*g)/i}}},Viva.Graph.Physics.nbodyForce=function(a){function b(a,b){this.node=a,this.body=b}function c(){this.stack=[],this.popIdx=0}a=Viva.lazyExtend(a||{gravity:-1,theta:.8}),c.prototype={isEmpty:function(){return 0===this.popIdx},push:function(a,c){var d=this.stack[this.popIdx];d?(d.node=a,d.body=c):this.stack[this.popIdx]=new b(a,c),++this.popIdx},pop:function(){return this.popIdx>0?this.stack[--this.popIdx]:void 0},reset:function(){this.popIdx=0}};var d=a.gravity,e=[],f=new c,g=a.theta,h=Viva.random("5f4dcc3b5aa765d61d8327deb882cf99",75,20,63,108,65,76,65,72),i=function(){this.body=null,this.quads=[],this.mass=0,this.massX=0,this.massY=0,this.left=0,this.top=0,this.bottom=0,this.right=0,this.isInternal=!1},j=[],k=0,l=function(){var a;return j[k]?(a=j[k],a.quads[0]=null,a.quads[1]=null,a.quads[2]=null,a.quads[3]=null,a.body=null,a.mass=a.massX=a.massY=0,a.left=a.right=a.top=a.bottom=0,a.isInternal=!1):(a=new i,j[k]=a),++k,a},m=l(),n=function(a,b){var c=Math.abs(a.x-b.x),d=Math.abs(a.y-b.y);return 1e-8>c&&1e-8>d},o=function(a){for(f.reset(),f.push(m,a);!f.isEmpty();){var b=f.pop(),c=b.node,d=b.body;if(c.isInternal){var e=d.location.x,g=d.location.y;c.mass=c.mass+d.mass,c.massX=c.massX+d.mass*e,c.massY=c.massY+d.mass*g;var i=0,j=c.left,k=(c.right+j)/2,o=c.top,p=(c.bottom+o)/2;if(e>k){i+=1;var q=j;j=k,k+=k-q}if(g>p){i+=2;var r=o;o=p,p+=p-r}var s=c.quads[i];s||(s=l(),s.left=j,s.top=o,s.right=k,s.bottom=p,c.quads[i]=s),f.push(s,d)}else if(c.body){var t=c.body;if(c.body=null,c.isInternal=!0,n(t.location,d.location)){if(c.right-c.left<1e-8)return;do{var u=h.nextDouble(),v=(c.right-c.left)*u,w=(c.bottom-c.top)*u;t.location.x=c.left+v,t.location.y=c.top+w}while(n(t.location,d.location))}f.push(c,t),f.push(c,d)}else c.body=d}},p=function(a){var b,c,f,i,j=e,k=1,l=0,n=1;for(j[0]=m;k;){var o=j[l],p=o.body;k-=1,l+=1,p&&p!==a?(c=p.location.x-a.location.x,f=p.location.y-a.location.y,i=Math.sqrt(c*c+f*f),0===i&&(c=(h.nextDouble()-.5)/50,f=(h.nextDouble()-.5)/50,i=Math.sqrt(c*c+f*f)),b=d*p.mass*a.mass/(i*i*i),a.force.x=a.force.x+b*c,a.force.y=a.force.y+b*f):(c=o.massX/o.mass-a.location.x,f=o.massY/o.mass-a.location.y,i=Math.sqrt(c*c+f*f),0===i&&(c=(h.nextDouble()-.5)/50,f=(h.nextDouble()-.5)/50,i=Math.sqrt(c*c+f*f)),(o.right-o.left)/i<g?(b=d*o.mass*a.mass/(i*i*i),a.force.x=a.force.x+b*c,a.force.y=a.force.y+b*f):(o.quads[0]&&(j[n]=o.quads[0],k+=1,n+=1),o.quads[1]&&(j[n]=o.quads[1],k+=1,n+=1),o.quads[2]&&(j[n]=o.quads[2],k+=1,n+=1),o.quads[3]&&(j[n]=o.quads[3],k+=1,n+=1)))}},q=function(a){var b,c=Number.MAX_VALUE,d=Number.MAX_VALUE,e=Number.MIN_VALUE,f=Number.MIN_VALUE,g=a.bodies,h=g.length;for(b=h;b--;){var i=g[b].location.x,j=g[b].location.y;c>i&&(c=i),i>e&&(e=i),d>j&&(d=j),j>f&&(f=j)}var n=e-c,p=f-d;for(n>p?f=d+n:e=c+p,k=0,m=l(),m.left=c,m.right=e,m.top=d,m.bottom=f,b=h;b--;)o(g[b],m)};return{insert:o,init:q,update:p,options:function(a){return a?("number"==typeof a.gravity&&(d=a.gravity),"number"==typeof a.theta&&(g=a.theta),this):{gravity:d,theta:g}}}},Viva.Graph.Physics.dragForce=function(a){a||(a={});var b={coeff:a.coeff||.01};return{update:function(a){a.force.x-=b.coeff*a.velocity.x,a.force.y-=b.coeff*a.velocity.y},options:function(a){return a?("number"==typeof a.coeff&&(b.coeff=a.coeff),this):b}}},Viva.Graph.Physics.springForce=function(a){a=Viva.lazyExtend(a,{length:50,coeff:22e-5});var b=Viva.random("Random number 4.","Chosen by fair dice roll");return{update:function(c){var d=c.body1,e=c.body2,f=c.length<0?a.length:c.length,g=e.location.x-d.location.x,h=e.location.y-d.location.y,i=Math.sqrt(g*g+h*h);0===i&&(g=(b.nextDouble()-.5)/50,h=(b.nextDouble()-.5)/50,i=Math.sqrt(g*g+h*h));var j=i-f,k=(!c.coeff||c.coeff<0?a.coeff:c.coeff)*j/i*c.weight;d.force.x+=k*g,d.force.y+=k*h,e.force.x+=-k*g,e.force.y+=-k*h},options:function(b){return b?("number"==typeof b.length&&(a.length=b.length),"number"==typeof b.coeff&&(a.coeff=b.coeff),this):a}}},Viva.Graph.Physics=Viva.Graph.Physics||{},Viva.Graph.Physics.forceSimulator=function(a){var b,c,d,e=a,f=[],g=[];return{speedLimit:1,bodies:f,accumulate:function(){var a,e;for(c.init(this),a=f.length;a--;)e=f[a],e.force.x=0,e.force.y=0,c.update(e),d.update(e);for(a=g.length;a--;)b.update(g[a])},run:function(a){return this.accumulate(),e.integrate(this,a)},addBody:function(a){if(!a)throw{message:"Cannot add null body to force simulator"};return f.push(a),a},removeBody:function(a){if(!a)return!1;var b=Viva.Graph.Utils.indexOfElementInArray(a,f);return 0>b?!1:f.splice(b,1)},addSpring:function(a,b,c,d,e){if(!a||!b)throw{message:"Cannot add null spring to force simulator"};if("number"!=typeof c)throw{message:"Spring length should be a number"};d="number"==typeof d?d:1;var f=new Viva.Graph.Physics.Spring(a,b,c,e>=0?e:-1,d);return g.push(f),f},removeSpring:function(a){if(!a)return!1;var b=Viva.Graph.Utils.indexOfElementInArray(a,g);return 0>b?!1:g.splice(b,1)},setNbodyForce:function(a){if(!a)throw{message:"Cannot add mighty (unknown) force to the simulator"};c=a},setDragForce:function(a){if(!a)throw{message:"Cannot add mighty (unknown) force to the simulator"};d=a},setSpringForce:function(a){if(!a)throw{message:"Cannot add unknown force to the simulator"};b=a}}},Viva.Graph.Layout=Viva.Graph.Layout||{},Viva.Graph.Layout.forceDirected=function(a,b){if(!a)throw{message:"Graph structure cannot be undefined"};b=Viva.lazyExtend(b,{springLength:80,springCoeff:2e-4,gravity:-1.2,theta:.8,dragCoeff:.02,springTransform:function(){},timeStep:20,stableThreshold:.001});var c=Viva.Graph.Physics.forceSimulator(Viva.Graph.Physics.eulerIntegrator()),d=Viva.Graph.Physics.nbodyForce({gravity:b.gravity,theta:b.theta}),e=Viva.Graph.Physics.springForce({length:b.springLength,coeff:b.springCoeff}),f=Viva.Graph.Physics.dragForce({coeff:b.dragCoeff}),g=new Viva.Graph.Rect,h=Viva.random("ted.com",103,114,101,97,116),i={},j=function(a){if(a.position)return a.position;var c=(g.x1+g.x2)/2,d=(g.y1+g.y2)/2,e=b.springLength;if(a.links&&a.links.length>0){var f=a.links[0],j=f.fromId!==a.id?i[f.fromId]:i[f.toId];j&&j.location&&(c=j.location.x,d=j.location.y)}return{x:c+h.next(e)-e/2,y:d+h.next(e)-e/2}},k=function(a){return i[a]},l=function(a){i[a]=null,delete i[a]},m={},n=function(b){var c=k(b);c.mass=1+a.getLinks(b).length/3},o=function(a){return a&&(a.isPinned||a.data&&a.data.isPinned)},p=function(a){return a.isPinned},q=function(b){var d=k(b);if(!d){var e=a.getNode(b);if(!e)return;d=new Viva.Graph.Physics.Body,i[b]=d;var f=j(e);d.loc(f),n(b),o(e)&&(d.isPinned=!0),c.addBody(d)}},r=function(a){q(a.id)},s=function(b){var d=k(b.id);d&&(l(b.id),c.removeBody(d),0===a.getNodesCount()&&(g.x1=g.y1=0,g.x2=g.y2=0))},t=function(a){n(a.fromId),n(a.toId);var d=k(a.fromId),e=k(a.toId),f=c.addSpring(d,e,-1,a.weight);b.springTransform(a,f),m[a.id]=f},u=function(b){var d=m[b.id];if(d){var e=a.getNode(b.fromId),f=a.getNode(b.toId);e&&n(e.id),f&&n(f.id),delete m[b.id],c.removeSpring(d)}},v=function(a){for(var b=0;b<a.length;++b){var c=a[b];"add"===c.changeType?(c.node&&q(c.node.id),c.link&&t(c.link)):"remove"===c.changeType&&(c.node&&s(c.node),c.link&&u(c.link))}},w=function(){a.forEachNode(r),a.forEachLink(t),a.addEventListener("changed",v)},x=function(){var b=Number.MAX_VALUE,c=Number.MAX_VALUE,d=Number.MIN_VALUE,e=Number.MIN_VALUE;if(0!==a.getNodesCount()){for(var f in i)if(i.hasOwnProperty(f)){var h=i[f];p(h)?(h.location.x=h.prevLocation.x,h.location.y=h.prevLocation.y):(h.prevLocation.x=h.location.x,h.prevLocation.y=h.location.y),h.location.x<b&&(b=h.location.x),h.location.x>d&&(d=h.location.x),h.location.y<c&&(c=h.location.y),h.location.y>e&&(e=h.location.y)}g.x1=b,g.x2=d,g.y1=c,g.y2=e}};return c.setSpringForce(e),c.setNbodyForce(d),c.setDragForce(f),w(),{run:function(a){var b;for(a=a||50,b=0;a>b;++b)this.step()},step:function(){var a=c.run(b.timeStep);return x(),a<b.stableThreshold},isNodePinned:function(a){var b=k(a.id);return b?p(b):void 0},pinNode:function(a,b){var c=k(a.id);c.isPinned=!!b},getNodePosition:function(a){var b=k(a);return b||(q(a),b=k(a)),b&&b.location},getLinkPosition:function(a){var b=this.getNodePosition(a.fromId),c=this.getNodePosition(a.toId);return{from:b,to:c}},setNodePosition:function(a,b,c){var d=k(a.id);d&&(d.prevLocation.x=d.location.x=b,d.prevLocation.y=d.location.y=c)},getGraphRect:function(){return g},dispose:function(){a.removeEventListener("change",v)},springLength:function(a){return 1===arguments.length?(e.options({length:a}),this):e.options().length},springCoeff:function(a){return 1===arguments.length?(e.options({coeff:a}),this):e.options().coeff},gravity:function(a){return 1===arguments.length?(d.options({gravity:a}),this):d.options().gravity},theta:function(a){return 1===arguments.length?(d.options({theta:a}),this):d.options().theta},drag:function(a){return 1===arguments.length?(f.options({coeff:a}),this):f.options().coeff}}},Viva.Graph.Layout=Viva.Graph.Layout||{},Viva.Graph.Layout.constant=function(a,b){b=Viva.lazyExtend(b,{maxX:1024,maxY:1024,seed:"Deterministic randomness made me do this"});var c=Viva.random(b.seed),d=new Viva.Graph.Rect(Number.MAX_VALUE,Number.MAX_VALUE,Number.MIN_VALUE,Number.MIN_VALUE),e=function(){return new Viva.Graph.Point2d(c.next(b.maxX),c.next(b.maxY))},f=function(a,b){a.x<b.x1&&(b.x1=a.x),a.x>b.x2&&(b.x2=a.x),a.y<b.y1&&(b.y1=a.y),a.y>b.y2&&(b.y2=a.y)},g="function"==typeof Object.create?Object.create(null):{},h=function(a){a&&(g[a.id]=e(a),f(g[a.id],d))},i=function(){0!==a.getNodesCount()&&(d.x1=Number.MAX_VALUE,d.y1=Number.MAX_VALUE,d.x2=Number.MIN_VALUE,d.y2=Number.MIN_VALUE,a.forEachNode(h))},j=function(a){for(var b=0;b<a.length;++b){var c=a[b];c.node&&("add"===c.changeType?h(c.node):delete g[c.node.id])}};return a.addEventListener("changed",j),{run:function(){this.step()},step:function(){return i(),!0},getGraphRect:function(){return d},dispose:function(){a.removeEventListener("change",j)},isNodePinned:function(){return!0},pinNode:function(){},getNodePosition:function(b){var c=g[b];return c||h(a.getNode(b)),c},getLinkPosition:function(a){var b=this.getNodePosition(a.fromId),c=this.getNodePosition(a.toId);return{from:b,to:c}},setNodePosition:function(a,b,c){var d=g[a.id];d&&(d.x=b,d.y=c)},placeNode:function(a){return"function"==typeof a?(e=a,i(),this):e(a)}}},Viva.Graph.View=Viva.Graph.View||{},Viva.Graph.View.renderer=function(a,b){var c=30;b=b||{};var d,e,f,g,h=b.layout,i=b.graphics,j=b.container,k=void 0!==b.interactive?b.interactive:!0,l=!1,m=!0,n=0,o=0,p=!1,q=!1,r={x:0,y:0},s={offsetX:0,offsetY:0,scale:1},t=function(){j=j||window.document.body,h=h||Viva.Graph.Layout.forceDirected(a),i=i||Viva.Graph.View.svgGraphics(a,{container:j}),b.hasOwnProperty("renderLinks")||(b.renderLinks=!0),b.prerender=b.prerender||0,d=(i.inputManager||Viva.Input.domInputManager)(a,i)},u=Viva.Graph.Utils.events(window),v=Viva.Graph.Utils.events({}).extend(),w=function(){i.beginRender(),b.renderLinks&&i.renderLinks(),i.renderNodes(),i.endRender()},x=function(){return p=h.step()&&!q,w(),!p},y=function(a){return e?void(o+=a):void(a?(o+=a,e=Viva.Graph.Utils.timer(function(){return x()},c)):(n=0,o=0,e=Viva.Graph.Utils.timer(x,c)))},z=function(){p=!1,e.restart()},A=function(){var a;if("number"==typeof b.prerender&&b.prerender>0)for(a=0;a<b.prerender;a+=1)h.step()},B=function(){var a=h.getGraphRect(),b=Viva.Graph.Utils.getDimension(j);r.x=r.y=0,s.offsetX=b.width/2-(a.x2+a.x1)/2,s.offsetY=b.height/2-(a.y2+a.y1)/2,i.graphCenterChanged(s.offsetX,s.offsetY),m=!1},C=function(a){var b=h.getNodePosition(a.id);i.addNode(a,b)},D=function(a){i.releaseNode(a)},E=function(a){var b=h.getLinkPosition(a);i.addLink(a,b)},F=function(a){i.releaseLink(a)},G=function(a){var b=!1,c="string"==typeof k&&-1!==k.indexOf("node")||k;c&&d.bindDragNDrop(a,{onStart:function(){b=h.isNodePinned(a),h.pinNode(a,!0),q=!0,z()},onDrag:function(b,c){var d=h.getNodePosition(a.id);h.setNodePosition(a,d.x+c.x/s.scale,d.y+c.y/s.scale),q=!0,w()},onStop:function(){h.pinNode(a,b),q=!1}})},H=function(a){d.bindDragNDrop(a,null)},I=function(){i.init(j),a.forEachNode(C),b.renderLinks&&a.forEachLink(E)},J=function(){i.release(j)},K=function(b){var c=b.node;"add"===b.changeType?(C(c),G(c),m&&B()):"remove"===b.changeType?(H(c),D(c),0===a.getNodesCount()&&(m=!0)):"update"===b.changeType&&(H(c),D(c),C(c),G(c))},L=function(a){var c=a.link;if("add"===a.changeType)b.renderLinks&&E(c);else if("remove"===a.changeType)b.renderLinks&&F(c);else if("update"===a.changeType)throw"Update type is not implemented. TODO: Implement me!"},M=function(a){var b,c;for(b=0;b<a.length;b+=1)c=a[b],c.node?K(c):c.link&&L(c);z()},N=function(){B(),x()},O=function(){g&&(g.release(),g=null)},P=function(){f&&(f.stop("changed",M),f=null)},Q=function(a,b){if(!b){var c=Viva.Graph.Utils.getDimension(j);b={x:c.width/2,y:c.height/2}}var d=Math.pow(1.4,a?-.2:.2);return s.scale=i.scale(d,b),w(),v.fire("scale",s.scale),s.scale},R=function(){u.on("resize",N),O();var b="string"==typeof k&&-1!==k.indexOf("drag")||k;b&&(g=Viva.Graph.Utils.dragndrop(j),g.onDrag(function(a,b){r.x+=b.x,r.y+=b.y,i.translateRel(b.x,b.y),w()}));var c="string"==typeof k&&-1!==k.indexOf("scroll")||k;c&&g.onScroll(function(a,b,c){Q(0>b,c)}),a.forEachNode(G),P(),f=Viva.Graph.Utils.events(a),f.on("changed",M)},S=function(){l=!1,P(),O(),u.stop("resize",N),v.removeAllListeners(),e.stop(),a.forEachLink(function(a){b.renderLinks&&F(a)}),a.forEachNode(function(a){H(a),D(a)}),h.dispose(),J()};return{run:function(a){return l||(t(),A(),B(),I(),R(),l=!0),y(a),this},reset:function(){i.resetScale(),B(),s.scale=1},pause:function(){e.stop()},resume:function(){e.restart()},rerender:function(){return w(),this},zoomOut:function(){return Q(!0)},zoomIn:function(){return Q(!1)},moveTo:function(a,b){i.graphCenterChanged(s.offsetX-a*s.scale,s.offsetY-b*s.scale),w()},getGraphics:function(){return i},dispose:function(){S()},on:function(a,b){return v.addEventListener(a,b),this},off:function(a,b){return v.removeEventListener(a,b),this}}},Viva.Graph.serializer=function(){var a=function(){if("undefined"==typeof JSON||!JSON.stringify||!JSON.parse)throw"JSON serializer is not defined."},b=function(a){return{id:a.id,data:a.data}},c=function(a){return{fromId:a.fromId,toId:a.toId,data:a.data}},d=function(a){return a},e=function(a){return a};return{storeToJSON:function(d,e,f){if(!d)throw"Graph is not defined";a(),e=e||b,f=f||c;var g={nodes:[],links:[]};return d.forEachNode(function(a){g.nodes.push(e(a))}),d.forEachLink(function(a){g.links.push(f(a))}),JSON.stringify(g)},loadFromJSON:function(b,c,f){if("string"!=typeof b)throw"String expected in loadFromJSON() method";a(),c=c||d,f=f||e;var g,h=JSON.parse(b),i=Viva.Graph.graph();if(!h||!h.nodes||!h.links)throw"Passed json string does not represent valid graph";for(g=0;g<h.nodes.length;++g){var j=c(h.nodes[g]);if(!j.hasOwnProperty("id"))throw"Graph node format is invalid. Node.id is missing";i.addNode(j.id,j.data)}for(g=0;g<h.links.length;++g){var k=f(h.links[g]);if(!k.hasOwnProperty("fromId")||!k.hasOwnProperty("toId"))throw"Graph link format is invalid. Both fromId and toId are required";i.addLink(k.fromId,k.toId,k.data)}return i}}},Viva.Graph.centrality=function(){var a=function(a,b,c){var d,e,f,g={},h=[],i={},j={},k=[b.id],l=function(a){j.hasOwnProperty(a.id)||(k.push(a.id),j[a.id]=e+1),j[a.id]===e+1&&(i[a.id]+=f,g[a.id].push(d))};for(a.forEachNode(function(a){g[a.id]=[],i[a.id]=0}),j[b.id]=0,i[b.id]=1;k.length;)d=k.shift(),e=j[d],f=i[d],h.push(d),a.forEachLinkedNode(d,l,c);return{S:h,P:g,sigma:i}},b=function(a,b,c){var d,e,f,g,h,i={},j=b.S;for(d=0;d<j.length;d+=1)i[j[d]]=0;for(;j.length;){for(e=j.pop(),f=(1+i[e])/b.sigma[e],g=b.P[e],d=0;d<g.length;d+=1)h=g[d],i[h]+=b.sigma[h]*f;e!==c&&(a[e]+=i[e])}},c=function(a){var b,c=[];for(b in a)a.hasOwnProperty(b)&&c.push({key:b,value:a[b]});return c.sort(function(a,b){return b.value-a.value})};return{betweennessCentrality:function(d){var e,f={};return d.forEachNode(function(a){f[a.id]=0}),d.forEachNode(function(c){e=a(d,c),b(f,e,c)}),c(f)},degreeCentrality:function(a,b){var c,d,e=[],f=[];if(b=(b||"both").toLowerCase(),"in"===b)c=function(a,b){var c,d=0;for(c=0;c<a.length;c+=1)d+=a[c].toId===b?1:0;return d};else if("out"===b)c=function(a,b){var c,d=0;for(c=0;c<a.length;c+=1)d+=a[c].fromId===b?1:0;return d};else{if("both"!==b)throw"Expected centrality degree kind is: in, out or both";c=function(a){return a.length}}a.forEachNode(function(b){var d=a.getLinks(b.id),f=c(d,b.id);e.hasOwnProperty(f)?e[f].push(b.id):e[f]=[b.id]});for(d in e)if(e.hasOwnProperty(d)){var g,h=e[d];if(h)for(g=0;g<h.length;++g)f.unshift({key:h[g],value:parseInt(d,10)})}return f}}},Viva.Graph.community=function(){return{slpa:function(a,b,c){var d=Viva.Graph._community.slpaAlgorithm(a,b,c);return d.run()}}},Viva.Graph._community={},Viva.Graph._community.slpaAlgorithm=function(a,b,c){b=b||100,c=c||.3;var d=Viva.random(1331782216905),e=Viva.random("Greeting goes to you, ","dear reader"),f=function(a,c){var d=[];return a.forEachUniqueWord(function(a,e){return e>c?void d.push({name:a,probability:e/b}):!0}),d},g=function(a){var b=[];return a.forEachNode(function(a){var c=Viva.Graph._community.occuranceMap(d);c.add(a.id),a.slpa={memory:c},b.push(a.id)}),b},h=function(a,c){var f,g=Viva.randomIterator(c,e),h=function(b){var c=a.getNode(b),e=Viva.Graph._community.occuranceMap(d);a.forEachLinkedNode(b,function(a){var b=a.slpa.memory.getRandomWord();e.add(b)});var f=e.getMostPopularFair();c.slpa.memory.add(f)};for(f=0;b-1>f;++f)g.forEach(h)},i=function(a){var d={};return a.forEachNode(function(a){var e,g=f(a.slpa.memory,c*b);for(e=0;e<g.length;++e){var h=g[e].name;d.hasOwnProperty(h)?d[h].push(a.id):d[h]=[a.id]}a.communities=g,a.slpa=null,delete a.slpa}),d};return{run:function(){var b=g(a);return h(a,b),i(a)}}},Viva.Graph._community.occuranceMap=function(a){a=a||Viva.random();var b={},c=[],d=!1,e=[],f=function(){var a;e.length=0;for(a in b)b.hasOwnProperty(a)&&e.push(a);e.sort(function(a,c){var d=b[c]-b[a];return d?d:c>a?-1:a>c?1:0})},g=function(){d&&(f(),d=!1)};return{add:function(a){a=String(a),b.hasOwnProperty(a)?b[a]+=1:b[a]=1,c.push(a),d=!0},getWordCount:function(a){return b[a]||0},getMostPopularFair:function(){if(1===c.length)return c[0];g();var d,f=0;for(d=1;d<e.length&&b[e[d-1]]===b[e[d]];++d)f+=1;return f+=1,e[a.next(f)]},getRandomWord:function(){if(0===c.length)throw"The occurance map is empty. Cannot get empty word";return c[a.next(c.length)]},forEachUniqueWord:function(a){if("function"!=typeof a)throw"Function callback is expected to enumerate all words";var c;for(g(),c=0;c<e.length;++c){var d=e[c],f=b[d],h=a(d,f);if(h)break}}}},Viva.Graph.generator=function(){return{complete:function(a){if(!a||1>a)throw{message:"At least two nodes expected for complete graph"};var b,c,d=Viva.Graph.graph();for(d.Name="Complete K"+a,b=0;a>b;++b)for(c=b+1;a>c;++c)b!==c&&d.addLink(b,c);return d},completeBipartite:function(a,b){if(!a||!b||0>a||0>b)throw{message:"Graph dimensions are invalid. Number of nodes in each partition should be greate than 0"};
var c,d,e=Viva.Graph.graph();for(e.Name="Complete K "+a+","+b,c=0;a>c;++c)for(d=a;a+b>d;++d)e.addLink(c,d);return e},ladder:function(a){if(!a||0>a)throw{message:"Invalid number of nodes"};var b,c=Viva.Graph.graph();for(c.Name="Ladder graph "+a,b=0;a-1>b;++b)c.addLink(b,b+1),c.addLink(a+b,a+b+1),c.addLink(b,a+b);return c.addLink(a-1,2*a-1),c},circularLadder:function(a){if(!a||0>a)throw{message:"Invalid number of nodes"};var b=this.ladder(a);return b.Name="Circular ladder graph "+a,b.addLink(0,a-1),b.addLink(a,2*a-1),b},grid:function(a,b){var c,d,e=Viva.Graph.graph();for(e.Name="Grid graph "+a+"x"+b,c=0;a>c;++c)for(d=0;b>d;++d){var f=c+d*a;c>0&&e.addLink(f,c-1+d*a),d>0&&e.addLink(f,c+(d-1)*a)}return e},path:function(a){if(!a||0>a)throw{message:"Invalid number of nodes"};var b,c=Viva.Graph.graph();for(c.Name="Path graph "+a,c.addNode(0),b=1;a>b;++b)c.addLink(b-1,b);return c},lollipop:function(a,b){if(!b||0>b||!a||0>a)throw{message:"Invalid number of nodes"};var c,d=this.complete(a);for(d.Name="Lollipop graph. Head x Path "+a+"x"+b,c=0;b>c;++c)d.addLink(a+c-1,a+c);return d},balancedBinTree:function(a){var b,c=Viva.Graph.graph(),d=Math.pow(2,a);for(c.Name="Balanced bin tree graph "+a,b=1;d>b;++b){var e=b,f=2*e,g=2*e+1;c.addLink(e,f),c.addLink(e,g)}return c},randomNoLinks:function(a){if(!a||0>a)throw{message:"Invalid number of nodes"};var b,c=Viva.Graph.graph();for(c.Name="Random graph, no Links: "+a,b=0;a>b;++b)c.addNode(b);return c}}},Viva.Graph.View=Viva.Graph.View||{},Viva.Graph.View.cssGraphics=function(){var a,b,c,d="OLD_IE",e=1,f=1,g=function(){var a,b,c=Viva.BrowserInfo.browser;switch(c){case"mozilla":a="Moz";break;case"webkit":a="webkit";break;case"opera":a="O";break;case"msie":if(b=Viva.BrowserInfo.version.split(".")[0],!(b>8))return d;a="ms"}return a?a+"Transform":null}(),h=function(){return g===d?function(a,b,c,d){var e=Math.cos(d),f=Math.sin(d);0>d&&(d=2*Math.PI+d),d<Math.PI/2?(a.style.left=b+"px",a.style.top=c+"px"):d<Math.PI?(a.style.left=b-a.clientWidth*Math.cos(Math.PI-d),a.style.top=c):d<Math.PI+Math.PI/2?(a.style.left=b-a.clientWidth*Math.cos(Math.PI-d),a.style.top=c+a.clientWidth*Math.sin(Math.PI-d)):(a.style.left=b,a.style.top=c+a.clientWidth*Math.sin(Math.PI-d)),a.style.filter='progid:DXImageTransform.Microsoft.Matrix(sizingMethod="auto expand",M11='+e+", M12="+-f+",M21="+f+", M22="+e+");"}:g?function(a,b,c,d){a.style.left=b+"px",a.style.top=c+"px",a.style[g]="rotate("+d+"rad)",a.style[g+"Origin"]="left"}:function(){}}(),i=function(){var a=window.document.createElement("div");return a.setAttribute("class","node"),a},j=function(a,b){a.style.left=b.x-5+"px",a.style.top=b.y-5+"px"},k=function(a,b,c){var d=b.x-c.x,e=b.y-c.y,f=Math.sqrt(d*d+e*e);a.style.height="1px",a.style.width=f+"px",h(a,c.x,c.y,Math.atan2(e,d))},l=function(){var a=window.document.createElement("div");return a.setAttribute("class","link"),a},m=function(){if(a){if(!g||g===d)throw"Not implemented. TODO: Implement OLD_IE Filter based transform";var h="matrix("+e+", 0, 0,"+f+","+b+","+c+")";a.style[g]=h}};return{node:function(a){return a&&"function"!=typeof a?i(a):(i=a,this)},link:function(a){return a&&"function"!=typeof a?l(a):(l=a,this)},inputManager:Viva.Input.domInputManager,graphCenterChanged:function(a,d){b=a,c=d,m()},translateRel:function(a,d){b+=a,c+=d,m()},scale:function(){return 1},resetScale:function(){return this},beginRender:function(){},endRender:function(){},placeNode:function(a){return j=a,this},placeLink:function(a){return k=a,this},init:function(b){a=b,m()},initLink:function(b){a.childElementCount>0?a.insertBefore(b,a.firstChild):a.appendChild(b)},releaseLink:function(b){a.removeChild(b)},initNode:function(b){a.appendChild(b)},releaseNode:function(b){a.removeChild(b)},updateNodePosition:function(a,b){j(a,b)},updateLinkPosition:function(a,b,c){k(a,b,c)}}},Viva.Graph.svg=function(a){var b="http://www.w3.org/2000/svg",c="http://www.w3.org/1999/xlink",d=a;return"string"==typeof a&&(d=window.document.createElementNS(b,a)),d.vivagraphAugmented?d:(d.vivagraphAugmented=!0,d.attr=function(a,b){return 2===arguments.length?(null!==b?d.setAttributeNS(null,a,b):d.removeAttributeNS(null,a),d):d.getAttributeNS(null,a)},d.append=function(a){var b=Viva.Graph.svg(a);return d.appendChild(b),b},d.text=function(a){return"undefined"!=typeof a?(d.textContent=a,d):d.textContent},d.link=function(a){return arguments.length?(d.setAttributeNS(c,"xlink:href",a),d):d.getAttributeNS(c,"xlink:href")},d.children=function(a){var b,c,e=[],f=d.childNodes.length;if(void 0===a&&d.hasChildNodes())for(b=0;f>b;b++)e.push(Viva.Graph.svg(d.childNodes[b]));else if("string"==typeof a){var g="."===a[0],h="#"===a[0],i=!g&&!h;for(b=0;f>b;b++){var j=d.childNodes[b];if(1===j.nodeType){var k=j.attr("class"),l=j.attr("id"),m=j.nodeName;if(g&&k){for(k=k.replace(/\s+/g," ").split(" "),c=0;c<k.length;c++)if(g&&k[c]===a.substr(1)){e.push(Viva.Graph.svg(j));break}}else{if(h&&l===a.substr(1)){e.push(Viva.Graph.svg(j));break}i&&m===a&&e.push(Viva.Graph.svg(j))}e=e.concat(Viva.Graph.svg(j).children(a))}}if(h&&1===e.length)return e[0]}return e},d)},Viva.Graph.View=Viva.Graph.View||{},Viva.Graph.View.svgGraphics=function(){var a,b,c,d,e,f=1,g={},h={},i=function(){return Viva.Graph.svg("rect").attr("width",10).attr("height",10).attr("fill","#00a2e8")},j=function(a,b){a.attr("x",b.x-5).attr("y",b.y-5)},k=function(){return Viva.Graph.svg("line").attr("stroke","#999")},l=function(a,b,c){a.attr("x1",b.x).attr("y1",b.y).attr("x2",c.x).attr("y2",c.y)},m=function(a){a.fire("rescaled")},n={x:0,y:0},o={x:0,y:0},p={x:0,y:0},q=function(){if(a){var b="matrix("+f+", 0, 0,"+f+","+c+","+d+")";a.attr("transform",b)}},r={getNodeUI:function(a){return g[a]},getLinkUI:function(a){return h[a]},node:function(a){return"function"==typeof a?(i=a,this):void 0},link:function(a){return"function"==typeof a?(k=a,this):void 0},placeNode:function(a){return j=a,this},placeLink:function(a){return l=a,this},beginRender:function(){},endRender:function(){},graphCenterChanged:function(a,b){c=a,d=b,q()},inputManager:Viva.Input.domInputManager,translateRel:function(c,d){var e=b.createSVGPoint(),f=a.getCTM(),g=b.createSVGPoint().matrixTransform(f.inverse());e.x=c,e.y=d,e=e.matrixTransform(f.inverse()),e.x=(e.x-g.x)*f.a,e.y=(e.y-g.y)*f.d,f.e+=e.x,f.f+=e.y;var h="matrix("+f.a+", 0, 0,"+f.d+","+f.e+","+f.f+")";a.attr("transform",h)},scale:function(e,g){var h=b.createSVGPoint();h.x=g.x,h.y=g.y,h=h.matrixTransform(a.getCTM().inverse());var i=b.createSVGMatrix().translate(h.x,h.y).scale(e).translate(-h.x,-h.y),j=a.getCTM().multiply(i);f=j.a,c=j.e,d=j.f;var k="matrix("+j.a+", 0, 0,"+j.d+","+j.e+","+j.f+")";return a.attr("transform",k),m(this),f},resetScale:function(){f=1;var b="matrix(1, 0, 0, 1, 0, 0)";return a.attr("transform",b),m(this),this},init:function(c){b=Viva.Graph.svg("svg"),a=Viva.Graph.svg("g").attr("buffered-rendering","dynamic"),b.appendChild(a),c.appendChild(b),q(),"function"==typeof e&&e(b)},release:function(a){b&&a&&a.removeChild(b)},addLink:function(b,c){var d=k(b);if(d)return d.position=c,d.link=b,h[b.id]=d,a.childElementCount>0?a.insertBefore(d,a.firstChild):a.appendChild(d),d},releaseLink:function(b){var c=h[b.id];c&&(a.removeChild(c),delete h[b.id])},addNode:function(b,c){var d=i(b);if(d)return d.position=c,d.node=b,g[b.id]=d,a.appendChild(d),d},releaseNode:function(b){var c=g[b.id];c&&(a.removeChild(c),delete g[b.id])},renderNodes:function(){for(var a in g)if(g.hasOwnProperty(a)){var b=g[a];n.x=b.position.x,n.y=b.position.y,j(b,n,b.node)}},renderLinks:function(){for(var a in h)if(h.hasOwnProperty(a)){var b=h[a];o.x=b.position.from.x,o.y=b.position.from.y,p.x=b.position.to.x,p.y=b.position.to.y,l(b,o,p,b.link)}},getGraphicsRoot:function(a){return"function"==typeof a&&(b?a(b):e=a),b},getSvgRoot:function(){return b}};return Viva.Graph.Utils.events(r).extend(),r},Viva.Graph.View.svgNodeFactory=function(a){var b="#999",c=Viva.Graph.geom(),d=function(a){a.size={w:10,h:10},a.append("rect").attr("width",a.size.w).attr("height",a.size.h).attr("stroke","orange").attr("fill","orange")},e=function(a){return a.size};return{node:function(a){var b=Viva.Graph.svg("g");return d(b,a),b.nodeId=a.id,b},link:function(c){var d=a.getNode(c.fromId),e=d&&d.ui;if(e&&!e.linksContainer){var f=Viva.Graph.svg("path").attr("stroke",b);return e.linksContainer=f,f}return null},customContent:function(a,b){if("function"!=typeof a||"function"!=typeof b)throw"Two functions expected: contentCreator(nodeUI, node) and size(nodeUI)";d=a,e=b},placeNode:function(b,d){var f="",g=e(b);a.forEachLinkedNode(b.nodeId,function(a,h){if(a.position&&a.ui&&a.ui!==b&&h.fromId===b.nodeId){var i=e(a.ui),j=a.position,k=c.intersectRect(d.x-g.w/2,d.y-g.h/2,d.x+g.w/2,d.y+g.h/2,d.x,d.y,j.x,j.y)||d,l=c.intersectRect(j.x-i.w/2,j.y-i.h/2,j.x+i.w/2,j.y+i.h/2,j.x,j.y,d.x,d.y)||j;f+="M"+Math.round(k.x)+" "+Math.round(k.y)+"L"+Math.round(l.x)+" "+Math.round(l.y)}}),b.attr("transform","translate("+(d.x-g.w/2)+", "+(d.y-g.h/2)+")"),""!==f&&b.linksContainer&&b.linksContainer.attr("d",f)}}},Viva.Graph.webgl=function(a){var b=function(b,c){var d=a.createShader(c);if(a.shaderSource(d,b),a.compileShader(d),!a.getShaderParameter(d,a.COMPILE_STATUS)){var e=a.getShaderInfoLog(d);throw window.alert(e),e}return d};return{createProgram:function(c,d){var e=a.createProgram(),f=b(c,a.VERTEX_SHADER),g=b(d,a.FRAGMENT_SHADER);if(a.attachShader(e,f),a.attachShader(e,g),a.linkProgram(e),!a.getProgramParameter(e,a.LINK_STATUS)){var h=a.getShaderInfoLog(e);throw window.alert(h),h}return e},extendArray:function(a,b,c){if((b+1)*c>a.length){var d=new Float32Array(a.length*c*2);return d.set(a),d}return a},copyArrayPart:function(a,b,c,d){var e;for(e=0;d>e;++e)a[b+e]=a[c+e]},swapArrayPart:function(a,b,c,d){var e;for(e=0;d>e;++e){var f=a[b+e];a[b+e]=a[c+e],a[c+e]=f}},getLocations:function(b,c){var d,e={};for(d=0;d<c.length;++d){var f=c[d],g=-1;if(0===f.indexOf("a_")){if(g=a.getAttribLocation(b,f),-1===g)throw"Program doesn't have required attribute: "+f;e[f.slice(2)]=g}else{if(0!==f.indexOf("u_"))throw"Couldn't figure out your intent. All uniforms should start with 'u_' prefix, and attributes with 'a_'";if(g=a.getUniformLocation(b,f),null===g)throw"Program doesn't have required uniform: "+f;e[f.slice(2)]=g}}return e},context:a}},Viva.Graph.View.WebglUtils=function(){},Viva.Graph.View.WebglUtils.prototype.parseColor=function(a){var b=10414335;if("string"==typeof a&&a)if(4===a.length&&(a=a.replace(/([^#])/g,"$1$1")),9===a.length)b=parseInt(a.substr(1),16);else{if(7!==a.length)throw'Color expected in hex format with preceding "#". E.g. #00ff00. Got value: '+a;b=parseInt(a.substr(1),16)<<8|255}else"number"==typeof a&&(b=a);return b},Viva.Graph.View._webglUtil=new Viva.Graph.View.WebglUtils,Viva.Graph.View.webglLine=function(a){return{color:Viva.Graph.View._webglUtil.parseColor(a)}},Viva.Graph.View.webglSquare=function(a,b){return{size:"number"==typeof a?a:10,color:Viva.Graph.View._webglUtil.parseColor(b)}},Viva.Graph.View.webglImage=function(a,b){return{_texture:0,_offset:0,size:"number"==typeof a?a:32,src:b}},Viva.Graph.View.webglNodeProgram=function(){var a,b,c,d,e,f,g,h,i,j=4,k=3*Float32Array.BYTES_PER_ELEMENT+Uint32Array.BYTES_PER_ELEMENT,l=["precision mediump float;","varying vec4 color;","void main(void) {","   gl_FragColor = color;","}"].join("\n"),m=["attribute vec3 a_vertexPos;","attribute vec4 a_color;","uniform vec2 u_screenSize;","uniform mat4 u_transform;","varying vec4 color;","void main(void) {","   gl_Position = u_transform * vec4(a_vertexPos.xy/u_screenSize, 0, 1);","   gl_PointSize = a_vertexPos.z * u_transform[0][0];","   color = a_color.abgr;","}"].join("\n"),n=new ArrayBuffer(16*k),o=new Float32Array(n),p=new Uint32Array(n),q=0,r=function(){if((q+1)*k>=n.byteLength){var a=new ArrayBuffer(2*n.byteLength),b=new Float32Array(a),c=new Uint32Array(a);c.set(p),o=b,p=c,n=a}};return{load:function(f){b=f,e=Viva.Graph.webgl(f),a=e.createProgram(m,l),b.useProgram(a),d=e.getLocations(a,["a_vertexPos","a_color","u_screenSize","u_transform"]),b.enableVertexAttribArray(d.vertexPos),b.enableVertexAttribArray(d.color),c=b.createBuffer()},position:function(a,b){var c=a.id;o[c*j]=b.x,o[c*j+1]=b.y,o[c*j+2]=a.size,p[c*j+3]=a.color},updateTransform:function(a){i=!0,h=a},updateSize:function(a,b){f=a,g=b,i=!0},removeNode:function(a){q>0&&(q-=1),a.id<q&&q>0&&e.copyArrayPart(p,a.id*j,q*j,j)},createNode:function(){r(),q+=1},replaceProperties:function(){},render:function(){b.useProgram(a),b.bindBuffer(b.ARRAY_BUFFER,c),b.bufferData(b.ARRAY_BUFFER,n,b.DYNAMIC_DRAW),i&&(i=!1,b.uniformMatrix4fv(d.transform,!1,h),b.uniform2f(d.screenSize,f,g)),b.vertexAttribPointer(d.vertexPos,3,b.FLOAT,!1,j*Float32Array.BYTES_PER_ELEMENT,0),b.vertexAttribPointer(d.color,4,b.UNSIGNED_BYTE,!0,j*Float32Array.BYTES_PER_ELEMENT,12),b.drawArrays(b.POINTS,0,q)}}},Viva.Graph.View.webglLinkProgram=function(){var a,b,c,d,e,f,g,h,i,j,k=6,l=2*(2*Float32Array.BYTES_PER_ELEMENT+Uint32Array.BYTES_PER_ELEMENT),m=["precision mediump float;","varying vec4 color;","void main(void) {","   gl_FragColor = color;","}"].join("\n"),n=["attribute vec2 a_vertexPos;","attribute vec4 a_color;","uniform vec2 u_screenSize;","uniform mat4 u_transform;","varying vec4 color;","void main(void) {","   gl_Position = u_transform * vec4(a_vertexPos/u_screenSize, 0.0, 1.0);","   color = a_color.abgr;","}"].join("\n"),o=0,p=new ArrayBuffer(16*l),q=new Float32Array(p),r=new Uint32Array(p),s=function(){if((o+1)*l>p.byteLength){var a=new ArrayBuffer(2*p.byteLength),b=new Float32Array(a),c=new Uint32Array(a);c.set(r),q=b,r=c,p=a}};return{load:function(f){b=f,d=Viva.Graph.webgl(f),a=d.createProgram(n,m),b.useProgram(a),e=d.getLocations(a,["a_vertexPos","a_color","u_screenSize","u_transform"]),b.enableVertexAttribArray(e.vertexPos),b.enableVertexAttribArray(e.color),c=b.createBuffer()},position:function(a,b,c){var d=a.id,e=d*k;q[e]=b.x,q[e+1]=b.y,r[e+2]=a.color,q[e+3]=c.x,q[e+4]=c.y,r[e+5]=a.color},createLink:function(a){s(),o+=1,f=a.id},removeLink:function(a){o>0&&(o-=1),a.id<o&&o>0&&d.copyArrayPart(r,a.id*k,o*k,k)},updateTransform:function(a){j=!0,i=a},updateSize:function(a,b){g=a,h=b,j=!0},render:function(){b.useProgram(a),b.bindBuffer(b.ARRAY_BUFFER,c),b.bufferData(b.ARRAY_BUFFER,p,b.DYNAMIC_DRAW),j&&(j=!1,b.uniformMatrix4fv(e.transform,!1,i),b.uniform2f(e.screenSize,g,h)),b.vertexAttribPointer(e.vertexPos,2,b.FLOAT,!1,3*Float32Array.BYTES_PER_ELEMENT,0),b.vertexAttribPointer(e.color,4,b.UNSIGNED_BYTE,!0,3*Float32Array.BYTES_PER_ELEMENT,8),b.drawArrays(b.LINES,0,2*o),f=o-1},bringToFront:function(a){f>a.id&&d.swapArrayPart(q,a.id*k,f*k,k),f>0&&(f-=1)},getFrontLinkId:function(){return f}}},Viva.Graph.View.Texture=function(a){this.canvas=window.document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.isDirty=!1,this.canvas.width=this.canvas.height=a},Viva.Graph.View.webglAtlas=function(a){var b,c,d=Math.sqrt(a||1024)<<0,e=d,f=1,g={},h=0,i=[],j=[],k=function(a){return 0===(a&a-1)},l=function(){var a=new Viva.Graph.View.Texture(d*e);i.push(a)},m=function(b){var c=b/a<<0,e=b%a,f=e/d<<0,g=e%d;return{textureNumber:c,row:f,col:g}},n=function(){c.isDirty=!0,h=0,b=null},o=function(){b&&(window.clearTimeout(b),h+=1,b=null),h>10?n():b=window.setTimeout(n,400)},p=function(a,b){var c=i[a.textureNumber].canvas,d=i[b.textureNumber].ctx,f=b.col*e,g=b.row*e;d.drawImage(c,a.col*e,a.row*e,e,e,f,g,e,e),i[a.textureNumber].isDirty=!0,i[b.textureNumber].isDirty=!0},q=function(a,b,c){var d=m(a),f={offset:a};d.textureNumber>=i.length&&l();var h=i[d.textureNumber];h.ctx.drawImage(b,d.col*e,d.row*e,e,e),j[a]=b.src,g[b.src]=f,h.isDirty=!0,c(f)};if(!k(a))throw"Tiles per texture should be power of two.";return c={isDirty:!1,clearDirty:function(){var a;for(this.isDirty=!1,a=0;a<i.length;++a)i[a].isDirty=!1},remove:function(a){var b=g[a];if(!b)return!1;if(delete g[a],f-=1,f===b.offset)return!0;var c=m(b.offset),d=m(f);p(d,c);var e=g[j[f]];return e.offset=b.offset,j[b.offset]=j[f],o(),!0},getTextures:function(){return i},getCoordinates:function(a){return g[a]},load:function(a,b){if(g.hasOwnProperty(a))b(g[a]);else{var c=new window.Image,d=f;f+=1,c.crossOrigin="anonymous",c.onload=function(){o(),q(d,c,b)},c.src=a}}}},Viva.Graph.View.webglImageNodeProgram=function(){var a,b,c,d,e,f,g,h,i,j,k=18,l=["precision mediump float;","varying vec4 color;","varying vec3 vTextureCoord;","uniform sampler2D u_sampler0;","uniform sampler2D u_sampler1;","uniform sampler2D u_sampler2;","uniform sampler2D u_sampler3;","void main(void) {","   if (vTextureCoord.z == 0.) {","     gl_FragColor = texture2D(u_sampler0, vTextureCoord.xy);","   } else if (vTextureCoord.z == 1.) {","     gl_FragColor = texture2D(u_sampler1, vTextureCoord.xy);","   } else if (vTextureCoord.z == 2.) {","     gl_FragColor = texture2D(u_sampler2, vTextureCoord.xy);","   } else if (vTextureCoord.z == 3.) {","     gl_FragColor = texture2D(u_sampler3, vTextureCoord.xy);","   } else { gl_FragColor = vec4(0, 1, 0, 1); }","}"].join("\n"),m=["attribute vec2 a_vertexPos;","attribute float a_customAttributes;","uniform vec2 u_screenSize;","uniform mat4 u_transform;","uniform float u_tilesPerTexture;","varying vec3 vTextureCoord;","void main(void) {","   gl_Position = u_transform * vec4(a_vertexPos/u_screenSize, 0, 1);","float corner = mod(a_customAttributes, 4.);","float tileIndex = mod(floor(a_customAttributes / 4.), u_tilesPerTexture);","float tilesPerRow = sqrt(u_tilesPerTexture);","float tileSize = 1./tilesPerRow;","float tileColumn = mod(tileIndex, tilesPerRow);","float tileRow = floor(tileIndex/tilesPerRow);","if(corner == 0.0) {","  vTextureCoord.xy = vec2(0, 1);","} else if(corner == 1.0) {","  vTextureCoord.xy = vec2(1, 1);","} else if(corner == 2.0) {","  vTextureCoord.xy = vec2(0, 0);","} else {","  vTextureCoord.xy = vec2(1, 0);","}","vTextureCoord *= tileSize;","vTextureCoord.x += tileColumn * tileSize;","vTextureCoord.y += tileRow * tileSize;","vTextureCoord.z = floor(floor(a_customAttributes / 4.)/u_tilesPerTexture);","}"].join("\n"),n=1024,o=0,p=new Float32Array(64),q=function(a,b){a.nativeObject&&c.deleteTexture(a.nativeObject);var d=c.createTexture();c.activeTexture(c["TEXTURE"+b]),c.bindTexture(c.TEXTURE_2D,d),c.texImage2D(c.TEXTURE_2D,0,c.RGBA,c.RGBA,c.UNSIGNED_BYTE,a.canvas),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MAG_FILTER,c.LINEAR),c.texParameteri(c.TEXTURE_2D,c.TEXTURE_MIN_FILTER,c.LINEAR_MIPMAP_NEAREST),c.generateMipmap(c.TEXTURE_2D),c.uniform1i(f["sampler"+b],b),a.nativeObject=d},r=function(){if(a.isDirty){var b,c=a.getTextures();for(b=0;b<c.length;++b)(c[b].isDirty||!c[b].nativeObject)&&q(c[b],b);a.clearDirty()}};return{load:function(g){c=g,e=Viva.Graph.webgl(g),a=new Viva.Graph.View.webglAtlas(n),b=e.createProgram(m,l),c.useProgram(b),f=e.getLocations(b,["a_vertexPos","a_customAttributes","u_screenSize","u_transform","u_sampler0","u_sampler1","u_sampler2","u_sampler3","u_tilesPerTexture"]),c.uniform1f(f.tilesPerTexture,n),c.enableVertexAttribArray(f.vertexPos),c.enableVertexAttribArray(f.customAttributes),d=c.createBuffer()},position:function(a,b){var c=a.id*k;p[c]=b.x-a.size,p[c+1]=b.y-a.size,p[c+2]=4*a._offset,p[c+3]=b.x+a.size,p[c+4]=b.y-a.size,p[c+5]=4*a._offset+1,p[c+6]=b.x-a.size,p[c+7]=b.y+a.size,p[c+8]=4*a._offset+2,p[c+9]=b.x-a.size,p[c+10]=b.y+a.size,p[c+11]=4*a._offset+2,p[c+12]=b.x+a.size,p[c+13]=b.y-a.size,p[c+14]=4*a._offset+1,p[c+15]=b.x+a.size,p[c+16]=b.y+a.size,p[c+17]=4*a._offset+3},createNode:function(b){p=e.extendArray(p,o,k),o+=1;var c=a.getCoordinates(b.src);c?b._offset=c.offset:(b._offset=0,a.load(b.src,function(a){b._offset=a.offset}))},removeNode:function(b){o>0&&(o-=1),b.id<o&&o>0&&(b.src&&a.remove(b.src),e.copyArrayPart(p,b.id*k,o*k,k))},replaceProperties:function(a,b){b._offset=a._offset},updateTransform:function(a){j=!0,i=a},updateSize:function(a,b){g=a,h=b,j=!0},render:function(){c.useProgram(b),c.bindBuffer(c.ARRAY_BUFFER,d),c.bufferData(c.ARRAY_BUFFER,p,c.DYNAMIC_DRAW),j&&(j=!1,c.uniformMatrix4fv(f.transform,!1,i),c.uniform2f(f.screenSize,g,h)),c.vertexAttribPointer(f.vertexPos,2,c.FLOAT,!1,3*Float32Array.BYTES_PER_ELEMENT,0),c.vertexAttribPointer(f.customAttributes,1,c.FLOAT,!1,3*Float32Array.BYTES_PER_ELEMENT,8),r(),c.drawArrays(c.TRIANGLES,0,6*o)}}},Viva.Graph.View=Viva.Graph.View||{},Viva.Graph.View.webglGraphics=function(a){a=Viva.lazyExtend(a,{enableBlending:!0,preserveDrawingBuffer:!1,clearColor:!1,clearColorValue:{r:1,g:1,b:1,a:1}});var b,c,d,e,f,g,h,i,j=0,k=0,l=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],m=[],n=[],o={},p={},q=Viva.Graph.View.webglLinkProgram(),r=Viva.Graph.View.webglNodeProgram(),s=function(){return Viva.Graph.View.webglSquare()},t=function(){return Viva.Graph.View.webglLine(3014898687)},u=function(){q.updateTransform(l),r.updateTransform(l)},v=function(){l=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]},w=function(){b&&c&&(e=c.width=Math.max(b.offsetWidth,1),f=c.height=Math.max(b.offsetHeight,1),d&&d.viewport(0,0,e,f),q&&q.updateSize(e/2,f/2),r&&r.updateSize(e/2,f/2))},x=function(a){a.fire("rescaled")},y={getLinkUI:function(a){return p[a]},getNodeUI:function(a){return o[a]},node:function(a){return"function"==typeof a?(s=a,this):void 0},link:function(a){return"function"==typeof a?(t=a,this):void 0},placeNode:function(a){return g=a,this},placeLink:function(a){return h=a,this},inputManager:Viva.Input.webglInputManager,beginRender:function(){},endRender:function(){k>0&&q.render(),j>0&&r.render()},bringLinkToFront:function(a){var b,c,d=q.getFrontLinkId();q.bringToFront(a),d>a.id&&(b=a.id,c=n[d],n[d]=n[b],n[d].id=d,n[b]=c,n[b].id=b)},graphCenterChanged:function(a,b){l[12]=2*a/e-1,l[13]=1-2*b/f,u()},addLink:function(a,b){var c=k++,d=t(a);return d.id=c,d.pos=b,q.createLink(d),n[c]=d,p[a.id]=d,d},addNode:function(a,b){var c=j++,d=s(a);return d.id=c,d.position=b,d.node=a,r.createNode(d),m[c]=d,o[a.id]=d,d},translateRel:function(a,b){l[12]+=2*l[0]*a/e/l[0],l[13]-=2*l[5]*b/f/l[5],u()},scale:function(a,b){var c=2*b.x/e-1,d=1-2*b.y/f;return c-=l[12],d-=l[13],l[12]+=c*(1-a),l[13]+=d*(1-a),l[0]*=a,l[5]*=a,u(),x(this),l[0]},resetScale:function(){return v(),d&&(w(),u()),this},init:function(g){var h={};if(a.preserveDrawingBuffer&&(h.preserveDrawingBuffer=!0),b=g,c=window.document.createElement("canvas"),w(),v(),b.appendChild(c),d=c.getContext("experimental-webgl",h),!d){var j="Could not initialize WebGL. Seems like the browser doesn't support it.";throw window.alert(j),j}if(a.enableBlending&&(d.blendFunc(d.SRC_ALPHA,d.ONE_MINUS_SRC_ALPHA),d.enable(d.BLEND)),a.clearColor){var k=a.clearColorValue;d.clearColor(k.r,k.g,k.b,k.a),this.beginRender=function(){d.clear(d.COLOR_BUFFER_BIT)}}q.load(d),q.updateSize(e/2,f/2),r.load(d),r.updateSize(e/2,f/2),u(),"function"==typeof i&&i(c)},release:function(a){c&&a&&a.removeChild(c)},isSupported:function(){var a=window.document.createElement("canvas"),b=a&&a.getContext&&a.getContext("experimental-webgl");return b},releaseLink:function(a){k>0&&(k-=1);var b=p[a.id];delete p[a.id],q.removeLink(b);var c=b.id;if(k>c){if(0===k||k===c)return;var d=n[k];n[c]=d,d.id=c}},releaseNode:function(a){j>0&&(j-=1);var b=o[a.id];delete o[a.id],r.removeNode(b);var c=b.id;if(j>c){if(0===j||j===c)return;var d=m[j];m[c]=d,d.id=c,r.replaceProperties(b,d)}},renderNodes:function(){for(var a={x:0,y:0},b=0;j>b;++b){var c=m[b];a.x=c.position.x,a.y=-c.position.y,g&&g(c,a),r.position(c,a)}},renderLinks:function(){if(!this.omitLinksRendering)for(var a={x:0,y:0},b={x:0,y:0},c=0;k>c;++c){var d=n[c],e=d.pos.from;b.x=e.x,b.y=-e.y,e=d.pos.to,a.x=e.x,a.y=-e.y,h&&h(d,b,a),q.position(d,b,a)}},getGraphicsRoot:function(a){return"function"==typeof a&&(c?a(c):i=a),c},setNodeProgram:function(a){if(!d&&a)r=a;else if(a)throw"Not implemented. Cannot swap shader on the fly... yet."},setLinkProgram:function(a){if(!d&&a)q=a;else if(a)throw"Not implemented. Cannot swap shader on the fly... yet."},transformClientToGraphCoordinates:function(a){return a.x=2*a.x/e-1,a.y=1-2*a.y/f,a.x=(a.x-l[12])/l[0],a.y=(a.y-l[13])/l[5],a.x*=e/2,a.y*=-f/2,a},getNodeAtClientPos:function(a,b){if("function"!=typeof b)return null;this.transformClientToGraphCoordinates(a);for(var c=0;j>c;++c)if(b(m[c],a.x,a.y))return m[c].node;return null}};return Viva.Graph.Utils.events(y).extend(),y},Viva.Graph.webglInputEvents=function(a){if(a.webglInputEvents)return a.webglInputEvents;var b,c,d=function(a,b,c){if(a&&a.size){var d=a.position,e=a.size;return d.x-e<b&&b<d.x+e&&d.y-e<c&&c<d.y+e}return!0},e=function(b){return a.getNodeAtClientPos(b,d)},f=null,g=[],h=[],i=[],j=[],k=[],l=[],m=[],n=Viva.Graph.Utils.events(window.document),o=function(a){a.stopPropagation?a.stopPropagation():a.cancelBubble=!0},p=function(a){return o(a),!1},q=function(a,b){var c,d;for(c=0;c<a.length;c+=1)if(d=a[c].apply(void 0,b))return!0},r=function(a){var d={x:0,y:0},r=null,s=+new Date,t=function(a){q(k,[r,a]),d.x=a.clientX,d.y=a.clientY},u=function(){n.stop("mousemove",t),n.stop("mouseup",u)},v=function(){c=a.getBoundingClientRect()};window.addEventListener("resize",v),v(),a.addEventListener("mousemove",function(a){if(!f){var b,i=!1;d.x=a.clientX-c.left,d.y=a.clientY-c.top,b=e(d),b&&r!==b?(r=b,i=i||q(g,[r])):null===b&&r!==b&&(i=i||q(h,[r]),r=null),i&&o(a)}}),a.addEventListener("mousedown",function(a){var f,g=!1;d.x=a.clientX-c.left,d.y=a.clientY-c.top,f=[e(d),a],f[0]?(g=q(i,f),n.on("mousemove",t),n.on("mouseup",u),b=window.document.onselectstart,window.document.onselectstart=p,r=f[0]):r=null,g&&o(a)}),a.addEventListener("mouseup",function(a){var f,g=+new Date;d.x=a.clientX-c.left,d.y=a.clientY-c.top,f=[e(d),a],f[0]&&(window.document.onselectstart=b,400>g-s&&f[0]===r?q(m,f):q(l,f),s=g,q(j,f)&&o(a))})};return a.getGraphicsRoot(r),a.webglInputEvents={mouseEnter:function(a){return"function"==typeof a&&g.push(a),this},mouseLeave:function(a){return"function"==typeof a&&h.push(a),this},mouseDown:function(a){return"function"==typeof a&&i.push(a),this},mouseUp:function(a){return"function"==typeof a&&j.push(a),this},mouseMove:function(a){return"function"==typeof a&&k.push(a),this},click:function(a){return"function"==typeof a&&l.push(a),this},dblClick:function(a){return"function"==typeof a&&m.push(a),this},mouseCapture:function(a){f=a},releaseMouseCapture:function(){f=null}},a.webglInputEvents},Viva.Input=Viva.Input||{},Viva.Input.webglInputManager=function(a,b){var c=Viva.Graph.webglInputEvents(b),d=null,e={},f={x:0,y:0};return c.mouseDown(function(a,b){d=a,f.x=b.clientX,f.y=b.clientY,c.mouseCapture(d);var g=e[a.id];return g&&g.onStart&&g.onStart(b,f),!0}).mouseUp(function(a){c.releaseMouseCapture(d),d=null;var b=e[a.id];return b&&b.onStop&&b.onStop(),!0}).mouseMove(function(a,b){if(d){var c=e[d.id];return c&&c.onDrag&&c.onDrag(b,{x:b.clientX-f.x,y:b.clientY-f.y}),f.x=b.clientX,f.y=b.clientY,!0}}),{bindDragNDrop:function(a,b){e[a.id]=b,b||delete e[a.id]}}};